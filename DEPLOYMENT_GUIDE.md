# デプロイメントガイド - PostgreSQL移行版

## 概要

このガイドでは、SQLiteからPostgreSQLへの移行と、Renderでの永続的なデータベースデプロイについて説明します。

## 問題の解決

### 従来の問題
- SQLiteデータベースが一時的なストレージに保存されていた
- デプロイのたびにコンテナが再作成され、データが失われていた
- ユーザー情報が永続化されていなかった

### 解決策
- PostgreSQLデータベースを使用して永続的なデータストレージを実現
- Renderの管理されたPostgreSQLデータベースを利用
- データ移行スクリプトによる既存データの保護

## デプロイ手順

### 1. Renderでの設定

1. **Renderダッシュボードにアクセス**
   - https://dashboard.render.com

2. **新しいPostgreSQLデータベースを作成**
   - "New" → "PostgreSQL"
   - データベース名: `flashcard-db`
   - ユーザー名: `flashcard_user`
   - プラン: Professional（推奨）

3. **Webサービスを更新**
   - 既存のWebサービスを選択
   - 環境変数を更新：
     - `DB_TYPE`: `postgresql`
     - `DB_HOST`: PostgreSQLのホスト名
     - `DB_PORT`: PostgreSQLのポート番号
     - `DB_NAME`: PostgreSQLのデータベース名
     - `DB_USER`: PostgreSQLのユーザー名
     - `DB_PASSWORD`: PostgreSQLのパスワード

### 2. コードの変更

以下のファイルが更新されています：

- `render.yaml`: PostgreSQLデータベース設定を追加
- `requirements.txt`: psycopg2-binaryを有効化
- `app.py`: PostgreSQLインポートを有効化
- `utils/db.py`: PostgreSQL接続を有効化
- `migrate_to_postgresql.py`: データ移行スクリプトを追加

### 3. デプロイ実行

1. **コードをGitにプッシュ**
   ```bash
   git add .
   git commit -m "PostgreSQL移行対応"
   git push origin main
   ```

2. **Renderでの自動デプロイ**
   - コードのプッシュにより自動的にデプロイが開始されます
   - 初回デプロイ時はデータ移行が実行されます

### 4. データ移行の確認

デプロイ後、以下のログを確認してください：

```
🔄 PostgreSQLデータベースへの移行を確認しています...
✅ データベース接続完了
👥 ユーザーデータを移行中...
✅ ユーザー 'admin' を移行しました
📚 教材データを移行中...
✅ 教材 'ファイナルステージ' を移行しました
✅ データ移行が完了しました
```

## トラブルシューティング

### よくある問題

1. **接続エラー**
   - 環境変数が正しく設定されているか確認
   - PostgreSQLデータベースが起動しているか確認

2. **データ移行エラー**
   - SQLiteファイルが存在するか確認
   - データベース権限が適切か確認

3. **アプリケーション起動エラー**
   - ログを確認して具体的なエラーメッセージを特定
   - データベーステーブルが正しく作成されているか確認

### ログの確認方法

Renderダッシュボードで：
1. Webサービスを選択
2. "Logs"タブをクリック
3. デプロイログとアプリケーションログを確認

## データの永続化

### PostgreSQLの利点

- **永続的なストレージ**: デプロイ後もデータが保持される
- **高可用性**: Renderが管理する高可用性データベース
- **スケーラビリティ**: 必要に応じてプランをアップグレード可能
- **バックアップ**: 自動バックアップ機能

### データ保護

- 既存のSQLiteデータは自動的にPostgreSQLに移行されます
- 重複データは自動的にスキップされます
- 移行処理は冪等性を保っています

## 運用上の注意点

1. **環境変数の管理**
   - 本番環境のデータベース接続情報は適切に管理してください
   - 開発環境と本番環境で異なるデータベースを使用してください

2. **バックアップ**
   - Renderの自動バックアップを活用してください
   - 重要なデータは定期的にエクスポートしてください

3. **監視**
   - データベースの使用量を定期的に確認してください
   - アプリケーションログを監視してください

## サポート

問題が発生した場合は、以下を確認してください：

1. Renderのドキュメント: https://render.com/docs
2. PostgreSQLのドキュメント: https://www.postgresql.org/docs/
3. アプリケーションのログとエラーメッセージ

---

**注意**: この移行により、ユーザーデータが永続化され、デプロイ後もデータが保持されるようになります。 