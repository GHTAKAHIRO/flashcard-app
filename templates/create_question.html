{% extends "base.html" %}

{% block title %}問題作成 - 暗記アプリ{% endblock %}

{% block content %}
<div class="mb-4">
    <h2 class="fw-bold">
        <i class="fas fa-plus-circle me-2"></i>問題作成
    </h2>
    <p class="text-muted">{{ unit.textbook_name }} - {{ unit.name }}</p>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-edit me-2"></i>新規問題作成
        </h5>
    </div>
    <div class="card-body">
        <form method="POST">
            <!-- 出題形式選択 -->
            <div class="mb-3">
                <label class="form-label">出題形式 <span class="text-danger">*</span></label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_type" id="question_type_input" value="input" checked>
                    <label class="form-check-label" for="question_type_input">
                        <i class="fas fa-keyboard me-1"></i>入力問題
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_type" id="question_type_choice" value="choice">
                    <label class="form-check-label" for="question_type_choice">
                        <i class="fas fa-list me-1"></i>選択問題
                    </label>
                </div>
            </div>

            <!-- 問題文 -->
            <div class="mb-3">
                <label for="question_text" class="form-label">問題文 <span class="text-danger">*</span></label>
                <textarea class="form-control" id="question_text" name="question_text" rows="3" required></textarea>
            </div>

            <!-- 正解 -->
            <div class="mb-3">
                <label for="correct_answer" class="form-label">正解 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="correct_answer" name="correct_answer" required>
            </div>

            <!-- 選択肢（選択問題の場合のみ表示） -->
            <div class="mb-3" id="choices_section" style="display: none;">
                <label class="form-label">選択肢の設定 <span class="text-danger">*</span></label>
                
                <!-- 選択肢の入力方法選択 -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="choices_method" id="choices_method_manual" value="manual" checked>
                        <label class="form-check-label" for="choices_method_manual">
                            <i class="fas fa-edit me-1"></i>手動入力
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="choices_method" id="choices_method_auto" value="auto">
                        <label class="form-check-label" for="choices_method_auto">
                            <i class="fas fa-magic me-1"></i>同じ単元から自動抽出
                        </label>
                    </div>
                </div>

                <!-- 手動入力セクション -->
                <div id="manual_choices_section">
                    <label for="choices" class="form-label">選択肢 <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="choices" name="choices" rows="4" 
                              placeholder="選択肢を1行に1つずつ入力してください&#10;例：&#10;選択肢A&#10;選択肢B&#10;選択肢C&#10;選択肢D"></textarea>
                    <div class="form-text">選択肢を1行に1つずつ入力してください</div>
                </div>

                <!-- 自動抽出セクション -->
                <div id="auto_choices_section" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        同じ単元内の他の問題の正解から選択肢を自動生成します。
                    </div>
                    <div class="mb-3">
                        <label for="auto_choices_count" class="form-label">選択肢の数</label>
                        <select class="form-select" id="auto_choices_count" name="auto_choices_count">
                            <option value="3">3個</option>
                            <option value="4" selected>4個</option>
                            <option value="5">5個</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="auto_choices_exclude" class="form-label">除外する問題番号</label>
                        <input type="text" class="form-control" id="auto_choices_exclude" name="auto_choices_exclude" 
                               placeholder="例：1,3,5（カンマ区切りで入力）">
                        <div class="form-text">特定の問題番号を選択肢の候補から除外できます</div>
                    </div>
                    <button type="button" class="btn btn-outline-primary" id="preview_choices_btn">
                        <i class="fas fa-eye me-1"></i>選択肢をプレビュー
                    </button>
                    <div id="choices_preview" class="mt-3" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">生成される選択肢（プレビュー）</h6>
                            </div>
                            <div class="card-body" id="choices_preview_content">
                                <!-- プレビュー内容がここに表示されます -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 許容回答 -->
            <div class="mb-3">
                <label for="acceptable_answers" class="form-label">許容回答</label>
                <textarea class="form-control" id="acceptable_answers" name="acceptable_answers" rows="2" 
                          placeholder="正解以外の許容される回答をカンマ区切りで入力"></textarea>
                <div class="form-text">正解以外の許容される回答をカンマ区切りで入力してください</div>
            </div>

            <!-- 回答の単位・接尾辞 -->
            <div class="mb-3">
                <label for="answer_suffix" class="form-label">回答の単位・接尾辞</label>
                <input type="text" class="form-control" id="answer_suffix" name="answer_suffix" 
                       placeholder="例：年、人、%">
            </div>

            <!-- 解説 -->
            <div class="mb-3">
                <label for="explanation" class="form-label">解説</label>
                <textarea class="form-control" id="explanation" name="explanation" rows="3" 
                          placeholder="問題の解説を入力してください"></textarea>
            </div>

            <!-- 難易度 -->
            <div class="mb-3">
                <label for="difficulty_level" class="form-label">難易度</label>
                <select class="form-select" id="difficulty_level" name="difficulty_level">
                    <option value="">選択してください</option>
                    <option value="easy">易しい</option>
                    <option value="medium">普通</option>
                    <option value="hard">難しい</option>
                </select>
            </div>

            <!-- 問題番号 -->
            <div class="mb-3">
                <label for="question_number" class="form-label">問題番号</label>
                <input type="number" class="form-control" id="question_number" name="question_number" 
                       placeholder="例：1">
            </div>

            <!-- ボタン -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-1"></i>問題を作成
                </button>
                <a href="{{ url_for('admin.manage_questions', unit_id=unit.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>戻る
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// 出題形式の選択に応じて選択肢セクションの表示/非表示を切り替え
document.addEventListener('DOMContentLoaded', function() {
    const inputRadio = document.getElementById('question_type_input');
    const choiceRadio = document.getElementById('question_type_choice');
    const choicesSection = document.getElementById('choices_section');
    const choicesTextarea = document.getElementById('choices');
    
    const manualRadio = document.getElementById('choices_method_manual');
    const autoRadio = document.getElementById('choices_method_auto');
    const manualChoicesSection = document.getElementById('manual_choices_section');
    const autoChoicesSection = document.getElementById('auto_choices_section');
    const previewBtn = document.getElementById('preview_choices_btn');
    const choicesPreview = document.getElementById('choices_preview');

    function toggleChoicesSection() {
        if (choiceRadio.checked) {
            choicesSection.style.display = 'block';
            choicesTextarea.required = manualRadio.checked;
        } else {
            choicesSection.style.display = 'none';
            choicesTextarea.required = false;
        }
    }

    function toggleChoicesMethod() {
        if (manualRadio.checked) {
            manualChoicesSection.style.display = 'block';
            autoChoicesSection.style.display = 'none';
            choicesTextarea.required = true;
        } else {
            manualChoicesSection.style.display = 'none';
            autoChoicesSection.style.display = 'block';
            choicesTextarea.required = false;
        }
    }

    // 選択肢のプレビュー機能
    function previewChoices() {
        const count = document.getElementById('auto_choices_count').value;
        const exclude = document.getElementById('auto_choices_exclude').value;
        const correctAnswer = document.getElementById('correct_answer').value;
        
        if (!correctAnswer) {
            alert('正解を入力してからプレビューしてください');
            return;
        }

        // AJAXで選択肢を取得
        fetch(`/admin/units/{{ unit.id }}/preview_choices`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                count: parseInt(count),
                exclude: exclude,
                correct_answer: correctAnswer
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const previewContent = document.getElementById('choices_preview_content');
                previewContent.innerHTML = data.choices.map((choice, index) => 
                    `<div class="mb-2"><strong>${String.fromCharCode(65 + index)}.</strong> ${choice}</div>`
                ).join('');
                choicesPreview.style.display = 'block';
            } else {
                alert('選択肢のプレビューに失敗しました: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('エラーが発生しました');
        });
    }

    inputRadio.addEventListener('change', toggleChoicesSection);
    choiceRadio.addEventListener('change', toggleChoicesSection);
    manualRadio.addEventListener('change', toggleChoicesMethod);
    autoRadio.addEventListener('change', toggleChoicesMethod);
    previewBtn.addEventListener('click', previewChoices);
});
</script>
{% endblock %} 