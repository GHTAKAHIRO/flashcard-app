<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å­¦ç¿’è¨­å®š</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    .progress-bar {
      background-color: #e9ecef;
      border-radius: 10px;
      height: 20px;
      margin: 20px 0;
      overflow: hidden;
    }
    .progress-fill {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      transition: width 0.3s ease;
    }
    .current-stage {
      margin: 20px 0;
      padding: 20px;
      border: 2px solid #007bff;
      border-radius: 10px;
      background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
    }
    .completed-stage {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #28a745;
      border-radius: 8px;
      background-color: #d4edda;
      opacity: 0.8;
    }
    .future-stage {
      margin: 15px 0;
      padding: 15px;
      border: 1px dashed #6c757d;
      border-radius: 8px;
      background-color: #f8f9fa;
      opacity: 0.6;
    }
    .stage-title {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    .stage-number {
      background-color: #007bff;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
    }
    .completed-number {
      background-color: #28a745;
    }
    .future-number {
      background-color: #6c757d;
    }
    .option {
      margin: 12px 0;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background-color: white;
    }
    .option input[type="radio"] {
      margin-right: 10px;
    }
    .option:hover {
      background-color: #f8f9fa;
    }
    .option.selected {
      border-color: #007bff;
      background-color: #e7f3ff;
    }
    .completed {
      color: #28a745;
      font-weight: bold;
    }
    .next-step {
      color: #007bff;
      font-weight: bold;
      font-size: 14px;
    }
    .unavailable {
      color: #6c757d;
      font-style: italic;
    }
    .description {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    button {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      width: 100%;
      transition: all 0.3s ease;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #6c757d;
      text-decoration: none;
    }
    .back-link:hover {
      color: #007bff;
    }
  </style>
</head>
<body>
  <h2>ğŸ“š å­¦ç¿’è¨­å®š</h2>

  <form method="POST" id="studyForm">
    {% if saved_page_range %}
    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #e3f2fd, #f8f9fa); border-radius: 10px; margin-bottom: 20px; border: 1px solid #007bff;">
      <h3 style="margin: 0; color: #007bff;">ğŸ“– å¯¾è±¡ãƒšãƒ¼ã‚¸: {{ saved_page_range }}</h3>
    </div>
    {% else %}
    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-radius: 10px; margin-bottom: 20px; border: 1px solid #ffc107;">
      <h3 style="margin: 0; color: #856404;">ğŸ“– å…¨ãƒšãƒ¼ã‚¸å¯¾è±¡</h3>
    </div>
    {% endif %}

    <!-- éè¡¨ç¤ºã®ãƒšãƒ¼ã‚¸ç¯„å›²ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
    <input type="hidden" name="page_range" value="{{ saved_page_range }}">

    <div style="margin-top: 30px;">
      <h3>ğŸ¯ å­¦ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸</h3>
      
      <!-- Stage 1 -->
      <div class="{% if 1 in completed['test'] and 1 in completed['practice'] %}completed-stage{% else %}current-stage{% endif %}">
        <div class="stage-title">
          <div class="stage-number {% if 1 in completed['test'] and 1 in completed['practice'] %}completed-number{% endif %}">1</div>
          ã‚¹ãƒ†ãƒ¼ã‚¸1: åŸºç¤ãƒ†ã‚¹ãƒˆ
        </div>
        
        {% if 1 not in completed['test'] %}
        <div class="option">
          <input type="radio" name="stage" value="1-test" id="stage1-test">
          <label for="stage1-test">
            <strong>ğŸ§ª ãƒ†ã‚¹ãƒˆï¼ˆå…¨å•é¡Œå¯¾è±¡ï¼‰</strong>
            <div class="description">ã¾ãšã¯å…¨å•é¡Œã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã€çŸ¥ã£ã¦ã„ã‚‹å•é¡Œã¨çŸ¥ã‚‰ãªã„å•é¡Œã‚’ä»•åˆ†ã‘ã—ã¾ã™</div>
          </label>
        </div>
        {% else %}
        <div style="padding: 10px; background-color: #d4edda; border-radius: 5px; margin-bottom: 10px;">
          <span class="completed">âœ… ãƒ†ã‚¹ãƒˆå®Œäº†</span>
        </div>
        {% endif %}

        {% if 1 in completed['test'] %}
          {% if 1 not in completed['practice'] %}
          <div class="option">
            <input type="radio" name="stage" value="1-practice" id="stage1-practice">
            <label for="stage1-practice">
              <strong>ğŸ“ ç·´ç¿’ï¼ˆÃ—å•é¡Œã‚’æ®µéšçš„ã«å­¦ç¿’ï¼‰</strong>
              <div class="description">ãƒ†ã‚¹ãƒˆã§Ã—ã ã£ãŸå•é¡Œã‚’ç¹°ã‚Šè¿”ã—ç·´ç¿’ã—ã¦ã€å…¨ã¦â—‹ã«ã—ã¾ã—ã‚‡ã†</div>
            </label>
          </div>
          {% else %}
          <div style="padding: 10px; background-color: #d4edda; border-radius: 5px;">
            <span class="completed">âœ… ç·´ç¿’å®Œäº†</span>
          </div>
          {% endif %}
        {% endif %}
      </div>

      <!-- Stage 2 -->
      {% if 1 in completed['practice'] and not completed.get('perfect_completion') %}
      <div class="{% if 2 in completed['test'] and 2 in completed['practice'] %}completed-stage{% elif 1 in completed['practice'] %}current-stage{% else %}future-stage{% endif %}">
        <div class="stage-title">
          <div class="stage-number {% if 2 in completed['test'] and 2 in completed['practice'] %}completed-number{% elif 1 not in completed['practice'] %}future-number{% endif %}">2</div>
          ã‚¹ãƒ†ãƒ¼ã‚¸2: å¾©ç¿’ãƒ†ã‚¹ãƒˆ
        </div>
        
        {% if 1 in completed['practice'] and 2 not in completed['test'] %}
        <div class="option">
          <input type="radio" name="stage" value="2-test" id="stage2-test">
          <label for="stage2-test">
            <strong>ğŸ§ª ãƒ†ã‚¹ãƒˆï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸1ã®Ã—å•é¡Œã®ã¿ï¼‰</strong>
            <div class="description">ç·´ç¿’ã®æˆæœã‚’ç¢ºèªï¼è¦šãˆãŸå•é¡Œã¨ã€ã¾ã è¦šãˆã¦ã„ãªã„å•é¡Œã‚’ä»•åˆ†ã‘ã—ã¾ã™</div>
          </label>
        </div>
        {% elif 2 in completed['test'] %}
        <div style="padding: 10px; background-color: #d4edda; border-radius: 5px; margin-bottom: 10px;">
          <span class="completed">âœ… ãƒ†ã‚¹ãƒˆå®Œäº†</span>
        </div>
        {% else %}
        <div style="padding: 10px; color: #6c757d;">
          <span class="unavailable">ã‚¹ãƒ†ãƒ¼ã‚¸1ã®ç·´ç¿’å®Œäº†å¾Œã«åˆ©ç”¨å¯èƒ½</span>
        </div>
        {% endif %}

        {% if 2 in completed['test'] and not completed.get('perfect_completion') %}
          {% if 2 not in completed['practice'] %}
          <div class="option">
            <input type="radio" name="stage" value="2-practice" id="stage2-practice">
            <label for="stage2-practice">
              <strong>ğŸ“ ç·´ç¿’ï¼ˆÃ—å•é¡Œã‚’æ®µéšçš„ã«å­¦ç¿’ï¼‰</strong>
              <div class="description">ã¾ã è¦šãˆã¦ã„ãªã„å•é¡Œã‚’ã•ã‚‰ã«ç·´ç¿’ã—ã¾ã™</div>
            </label>
          </div>
          {% else %}
          <div style="padding: 10px; background-color: #d4edda; border-radius: 5px;">
            <span class="completed">âœ… ç·´ç¿’å®Œäº†</span>
          </div>
          {% endif %}
        {% endif %}
      </div>
      {% endif %}

      <!-- Stage 3 -->
      {% if 2 in completed['practice'] and not completed.get('perfect_completion') %}
      <div class="{% if 3 in completed['test'] and 3 in completed['practice'] %}completed-stage{% elif 2 in completed['practice'] %}current-stage{% else %}future-stage{% endif %}">
        <div class="stage-title">
          <div class="stage-number {% if 3 in completed['test'] and 3 in completed['practice'] %}completed-number{% elif 2 not in completed['practice'] %}future-number{% endif %}">3</div>
          ã‚¹ãƒ†ãƒ¼ã‚¸3: æœ€çµ‚ç¢ºèª
        </div>
        
        {% if 2 in completed['practice'] and 3 not in completed['test'] %}
        <div class="option">
          <input type="radio" name="stage" value="3-test" id="stage3-test">
          <label for="stage3-test">
            <strong>ğŸ§ª ãƒ†ã‚¹ãƒˆï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸2ã®Ã—å•é¡Œã®ã¿ï¼‰</strong>
            <div class="description">æœ€çµ‚ç¢ºèªãƒ†ã‚¹ãƒˆï¼æœ¬å½“ã«è¦šãˆãŸã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™</div>
          </label>
        </div>
        {% elif 3 in completed['test'] %}
        <div style="padding: 10px; background-color: #d4edda; border-radius: 5px; margin-bottom: 10px;">
          <span class="completed">âœ… ãƒ†ã‚¹ãƒˆå®Œäº†</span>
        </div>
        {% else %}
        <div style="padding: 10px; color: #6c757d;">
          <span class="unavailable">ã‚¹ãƒ†ãƒ¼ã‚¸2ã®ç·´ç¿’å®Œäº†å¾Œã«åˆ©ç”¨å¯èƒ½</span>
        </div>
        {% endif %}

        {% if 3 in completed['test'] and not completed.get('perfect_completion') %}
          {% if 3 not in completed['practice'] %}
          <div class="option">
            <input type="radio" name="stage" value="3-practice" id="stage3-practice">
            <label for="stage3-practice">
              <strong>ğŸ“ ç·´ç¿’ï¼ˆæœ€å¾Œã®ä»•ä¸Šã’ï¼‰</strong>
              <div class="description">æœ€å¾Œã®ä»•ä¸Šã’ï¼æ®‹ã£ãŸå•é¡Œã‚’å®Œç’§ã«ã—ã¾ã—ã‚‡ã†</div>
            </label>
          </div>
          {% else %}
          <div style="padding: 10px; background-color: #d4edda; border-radius: 5px;">
            <span class="completed">ğŸ‰ å…¨ã‚¹ãƒ†ãƒ¼ã‚¸å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</span>
          </div>
          {% endif %}
        {% endif %}
      </div>
      {% endif %}

      <!-- å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      {% if completed.get('perfect_completion') %}
      <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; border-radius: 15px; margin-top: 20px; border: 3px solid #ffc107;">
        <h3>ğŸ† ç´ æ™´ã‚‰ã—ã„ï¼æº€ç‚¹é”æˆï¼</h3>
        <p><strong>ãƒ†ã‚¹ãƒˆã§æº€ç‚¹ã‚’å–ã£ãŸãŸã‚ã€å…¨ã¦ã®å­¦ç¿’ãŒå®Œäº†ã—ã¾ã—ãŸï¼</strong></p>
        <p>å¾©ç¿’ã—ãŸã„å ´åˆã¯ã€ä¸‹è¨˜ã®ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’ã„ã¤ã§ã‚‚é¸æŠã§ãã¾ã™ã€‚</p>
      </div>
      
      <!-- æº€ç‚¹é”æˆå¾Œã®å¾©ç¿’ç”¨ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º -->
      {% for stage in [1, 2, 3] %}
        {% if stage in completed['practice'] %}
        <div class="completed-stage" style="margin-top: 15px;">
          <div class="stage-title">
            <div class="stage-number completed-number">{{ stage }}</div>
            ã‚¹ãƒ†ãƒ¼ã‚¸{{ stage }}: å¾©ç¿’ç·´ç¿’
          </div>
          
          <div class="option">
            <input type="radio" name="stage" value="{{ stage }}-practice" id="review-stage{{ stage }}-practice">
            <label for="review-stage{{ stage }}-practice">
              <strong>ğŸ“ ç·´ç¿’ï¼ˆå¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼‰</strong>
              <div class="description">{% if stage == 1 %}åŸºç¤å•é¡Œ{% elif stage == 2 %}å¿œç”¨å•é¡Œ{% else %}ç™ºå±•å•é¡Œ{% endif %}ã‚’å¾©ç¿’ã§ãã¾ã™</div>
            </label>
          </div>
        </div>
        {% endif %}
      {% endfor %}
      
      {% elif 3 in completed['test'] and 3 in completed['practice'] %}
      <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border-radius: 10px; margin-top: 20px;">
        <h3>ğŸŠ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</h3>
        <p>å…¨ã¦ã®å­¦ç¿’ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚å¾©ç¿’ã—ãŸã„å ´åˆã¯ã€ã„ã¤ã§ã‚‚ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã§ãã¾ã™ã€‚</p>
      </div>
      {% endif %}
    </div>

    <div id="errorMessage" style="color: #dc3545; margin-top: 10px; display: none;"></div>

    <button type="submit" id="startButton">ğŸš€ å­¦ç¿’é–‹å§‹</button>
  </form>

  <a href="{{ url_for('dashboard') }}" class="back-link">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("studyForm");
      const pageRangeInput = document.getElementById("page_range");
      const errorMessage = document.getElementById("errorMessage");
      const options = document.querySelectorAll('.option');

      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’è¦–è¦šçš„ã«è¡¨ç¤º
      document.querySelectorAll('input[name="stage"]').forEach(radio => {
        radio.addEventListener('change', function() {
          options.forEach(opt => opt.classList.remove('selected'));
          if (this.checked) {
            this.closest('.option').classList.add('selected');
          }
        });
      });

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
      function validatePageRange() {
        const value = pageRangeInput.value.trim();
        if (!value) return { valid: true };

        const parts = value.split(",");
        const rangePattern = /^\d+\s*-\s*\d+$/;
        const numberPattern = /^\d+$/;

        for (let part of parts) {
          part = part.trim();
          if (!(rangePattern.test(part) || numberPattern.test(part))) {
            return {
              valid: false,
              message: "ãƒšãƒ¼ã‚¸ç¯„å›²ã¯ã€Œ2-4,6,8-10ã€ã®ã‚ˆã†ã«å…¥åŠ›ã—ã¦ãã ã•ã„"
            };
          }

          if (rangePattern.test(part)) {
            const [start, end] = part.split("-").map(s => parseInt(s.trim(), 10));
            if (start > end) {
              return {
                valid: false,
                message: `ãƒšãƒ¼ã‚¸ç¯„å›²ã€Œ${part}ã€ã¯ é–‹å§‹ãƒšãƒ¼ã‚¸ â‰¦ çµ‚äº†ãƒšãƒ¼ã‚¸ ã«ã—ã¦ãã ã•ã„`
              };
            }
          }
        }
        return { valid: true };
      }

      function validateStageSelection() {
        const selectedStage = document.querySelector('input[name="stage"]:checked');
        if (!selectedStage) {
          return {
            valid: false,
            message: "å­¦ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é¸æŠã—ã¦ãã ã•ã„"
          };
        }
        return { valid: true };
      }

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      form.addEventListener("submit", function (e) {
        const pageValidation = validatePageRange();
        const stageValidation = validateStageSelection();

        if (!pageValidation.valid) {
          e.preventDefault();
          errorMessage.textContent = pageValidation.message;
          errorMessage.style.display = "block";
          pageRangeInput.focus();
          return;
        }

        if (!stageValidation.valid) {
          e.preventDefault();
          errorMessage.textContent = stageValidation.message;
          errorMessage.style.display = "block";
          return;
        }

        errorMessage.style.display = "none";
      });
    });
  </script>
</body>
</html>