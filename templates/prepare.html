<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>学習設定</title>
</head>
<body>
  <h2>学習の設定をしてください</h2>

  <form method="POST">
    <div>
      <label for="page_range">ページ範囲:</label>
      <input type="text" id="page_range" name="page_range" placeholder="例: 2-4" value="{{ saved_page_range }}">
    </div>

    <div style="margin-top: 10px;">
      <label>ステージ選択:</label><br>
      <select name="stage" required>
        <option value="1-test" {% if 1 in completed['test'] %}disabled{% endif %}>
          ステージ1：テスト {% if 1 in completed['test'] %}（完了）{% endif %}
        </option>
        <option value="1-practice" {% if 1 in completed['practice'] %}disabled{% endif %}>
          ステージ1：練習 {% if 1 in completed['practice'] %}（完了）{% endif %}
        </option>

        <option value="2-test" {% if 2 in completed['test'] %}disabled{% endif %}>
          ステージ2：テスト {% if 2 in completed['test'] %}（完了）{% endif %}
        </option>
        <option value="2-practice" {% if 2 in completed['practice'] %}disabled{% endif %}>
          ステージ2：練習 {% if 2 in completed['practice'] %}（完了）{% endif %}
        </option>

        <option value="3-test" {% if 3 in completed['test'] %}disabled{% endif %}>
          ステージ3：テスト {% if 3 in completed['test'] %}（完了）{% endif %}
        </option>
        <option value="3-practice" {% if 3 in completed['practice'] %}disabled{% endif %}>
          ステージ3：練習 {% if 3 in completed['practice'] %}（完了）{% endif %}
        </option>
      </select>
    </div>

    <div style="margin-top: 20px;">
      <button type="submit">▶ この設定で学習開始</button>
    </div>
  </form>

  <a href="{{ url_for('dashboard') }}">← ダッシュボードに戻る</a>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.querySelector("form");
      const pageRangeInput = document.getElementById("page_range");

      form.addEventListener("submit", function (e) {
        const value = pageRangeInput.value.trim();

        if (!value) return;  // 空ならチェックしない（全ページ対象）

        const parts = value.split(",");
        const rangePattern = /^\d+\s*-\s*\d+$/;
        const numberPattern = /^\d+$/;

        for (let part of parts) {
          part = part.trim();
          if (!(rangePattern.test(part) || numberPattern.test(part))) {
            e.preventDefault();
            alert("ページ範囲は「2-4,6,8-10」のように入力してください（半角数字とハイフン、カンマ）。");
            pageRangeInput.focus();
            return;
          }

          if (rangePattern.test(part)) {
            const [start, end] = part.split("-").map(s => parseInt(s.trim(), 10));
            if (start > end) {
              e.preventDefault();
              alert(`ページ範囲「${part}」は開始ページ <= 終了ページにしてください。`);
              pageRangeInput.focus();
              return;
            }
          }
        }
      });
    });
  </script>

</body>
</html>
