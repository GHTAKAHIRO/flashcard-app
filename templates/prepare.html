<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>学習設定</title>
</head>
<body>
  <h2>学習の設定をしてください</h2>

  <form method="POST">
    <div>
      <label for="page_range">ページ範囲:</label>
      <input type="text" id="page_range" name="page_range" placeholder="例: 2-4" value="{{ saved_page_range }}">
    </div>

    <div style="margin-top: 10px;">
      <label>ステージ選択:</label><br>

      {% set test_completed = completed.get('test', set()) %}
      {% set practice_completed = completed.get('practice', set()) %}

      {% for stage in [1, 2, 3] %}
        <option value="{{ stage }}-test"
          {% if stage in test_completed %}disabled{% endif %}>
          ステージ{{ stage }}：テスト {% if stage in test_completed %}（完了）{% endif %}
        </option>

        <option value="{{ stage }}-practice"
          {% if stage in practice_completed %}disabled{% endif %}>
          ステージ{{ stage }}：練習 {% if stage in practice_completed %}（完了）{% endif %}
        </option>
      {% endfor %}
    </div>

    <div style="margin-top: 20px;">
      <button type="submit">▶ この設定で学習開始</button>
    </div>
  </form>

  <a href="{{ url_for('dashboard') }}">← ダッシュボードに戻る</a>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.querySelector("form");
      const pageRangeInput = document.getElementById("page_range");

      form.addEventListener("submit", function (e) {
        const value = pageRangeInput.value.trim();
        if (!value) return;

        const parts = value.split(",");
        const rangePattern = /^\d+\s*-\s*\d+$/;
        const numberPattern = /^\d+$/;

        for (let part of parts) {
          part = part.trim();
          if (!(rangePattern.test(part) || numberPattern.test(part))) {
            e.preventDefault();
            alert("ページ範囲は「2-4,6,8-10」のように入力してください（半角数字とハイフン、カンマ）。");
            pageRangeInput.focus();
            return;
          }

          if (rangePattern.test(part)) {
            const [start, end] = part.split("-").map(s => parseInt(s.trim(), 10));
            if (start > end) {
              e.preventDefault();
              alert(`ページ範囲「${part}」は 開始ページ <= 終了ページ にしてください。`);
              pageRangeInput.focus();
              return;
            }
          }
        }
      });
    });
  </script>

</body>
</html>
