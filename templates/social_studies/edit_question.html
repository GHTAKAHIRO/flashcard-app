{% extends "base.html" %}

{% block title %}å•é¡Œç·¨é›† - ç¤¾ä¼šç§‘ä¸€å•ä¸€ç­”ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="text-center mb-4">
            <h2 class="fw-bold">
                <i class="fas fa-edit me-2"></i>å•é¡Œç·¨é›†
            </h2>
            <p class="text-muted">å•é¡Œã®å†…å®¹ã‚’ç·¨é›†ã—ã¦å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ”¹å–„ã—ã¾ã—ã‚‡ã†</p>
        </div>

        <div class="card">
            <div class="card-body">
                <form id="editQuestionForm" onsubmit="saveQuestion(event)">
                    {% if textbook_info and unit_info %}
                        <!-- æ•™æã¨å˜å…ƒãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å›ºå®šè¡¨ç¤º -->
                        <div class="mb-3">
                            <label class="form-label">ç§‘ç›® <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" value="{{ question.subject or textbook_info.subject or 'æœªè¨­å®š' }}" readonly>
                            <input type="hidden" name="subject" value="{{ question.subject or textbook_info.subject or 'åœ°ç†' }}">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-book me-1"></i>æ•™æ
                            </label>
                            <input type="text" class="form-control" value="{{ textbook_info.name if textbook_info else 'æœªè¨­å®š' }}" readonly>
                            <input type="hidden" name="textbook_id" value="{{ question.textbook_id or '' }}">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-list-ol me-1"></i>å˜å…ƒãƒ»ç« 
                            </label>
                            <input type="text" class="form-control" value="{{ unit_info.name if unit_info else 'æœªè¨­å®š' }}{% if unit_info and unit_info.chapter_number %} (ç¬¬{{ unit_info.chapter_number }}ç« ){% endif %}" readonly>
                            <input type="hidden" id="unit_id" name="unit_id" value="{{ question.unit_id or '' }}">
                        </div>
                    {% else %}
                        <!-- é€šå¸¸ã®é¸æŠå½¢å¼ -->
                        <div class="mb-3">
                            <label for="subject" class="form-label">ç§‘ç›® <span class="text-danger">*</span></label>
                            <select class="form-select" id="subject" name="subject" required onchange="loadTextbooks()">
                                <option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="åœ°ç†" {% if question.subject == 'åœ°ç†' %}selected{% endif %}>åœ°ç†</option>
                                <option value="æ­´å²" {% if question.subject == 'æ­´å²' %}selected{% endif %}>æ­´å²</option>
                                <option value="å…¬æ°‘" {% if question.subject == 'å…¬æ°‘' %}selected{% endif %}>å…¬æ°‘</option>
                                <option value="ç†ç§‘" {% if question.subject == 'ç†ç§‘' %}selected{% endif %}>ç†ç§‘</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="textbook_id" class="form-label">
                                <i class="fas fa-book me-1"></i>æ•™æ
                            </label>
                            <select class="form-select" id="textbook_id" name="textbook_id" onchange="loadUnits()">
                                <option value="">æ•™æã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="unit_id" class="form-label">
                                <i class="fas fa-list-ol me-1"></i>å˜å…ƒãƒ»ç« 
                            </label>
                            <select class="form-select" id="unit_id" name="unit_id">
                                <option value="">å˜å…ƒãƒ»ç« ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>
                            </select>
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="difficulty_level" class="form-label">é›£æ˜“åº¦</label>
                        <select class="form-select" id="difficulty_level" name="difficulty_level">
                            <option value="basic" {% if question.difficulty_level == 'basic' %}selected{% endif %}>åŸºæœ¬</option>
                            <option value="intermediate" {% if question.difficulty_level == 'intermediate' %}selected{% endif %}>ä¸­ç´š</option>
                            <option value="advanced" {% if question.difficulty_level == 'advanced' %}selected{% endif %}>ä¸Šç´š</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="question" class="form-label">å•é¡Œæ–‡ <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="question" name="question" rows="3" 
                                  required>{{ question.question or '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="correct_answer" class="form-label">æ­£è§£ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="correct_answer" name="correct_answer" 
                               value="{{ question.correct_answer or '' }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="acceptable_answers" class="form-label">è¨±å®¹å›ç­”ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                        <input type="text" class="form-control" id="acceptable_answers" name="acceptable_answers" 
                               value="{{ question.acceptable_answers or '' }}">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            æ­£è§£ä»¥å¤–ã§ã‚‚æ­£è§£ã¨ã—ã¦æ‰±ã„ãŸã„å›ç­”ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="answer_suffix" class="form-label">
                            <i class="fas fa-plus me-1"></i>è§£ç­”æ¬„ã®å¾Œè£œè¶³
                        </label>
                        <input type="text" class="form-control" id="answer_suffix" name="answer_suffix" 
                               value="{{ question.answer_suffix or '' }}" oninput="updatePreview()">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            è§£ç­”æ¬„ã«äºˆã‚è¡¨ç¤ºã—ãŸã„è£œè¶³æƒ…å ±ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„
                        </div>
                        <div id="preview-section" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <small>
                                    <strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong> å•é¡Œæ–‡ã®ä¸‹ã«ã€Œç­”ãˆã®å¾Œã«ã€Œ<span id="preview-suffix"></span>ã€ãŒä»˜ãã¾ã™ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="explanation" class="form-label">
                            <i class="fas fa-lightbulb me-1"></i>è§£èª¬
                        </label>
                        <textarea class="form-control" id="explanation" name="explanation" rows="3">{{ question.explanation or '' }}</textarea>
                    </div>
                    
                    {% if textbook_info and unit_info %}
                    <!-- å›ºå®šè¡¨ç¤ºã®å ´åˆã®ç”»åƒãƒ‘ã‚¹ -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-folder-open me-1"></i>ç”»åƒä¿å­˜å…ˆ
                        </label>
                        <input type="text" class="form-control" id="image_path_display" value="{{ image_path_info.base_url if image_path_info else 'èª­ã¿è¾¼ã¿ä¸­...' }}" readonly>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="image_name" class="form-label">
                            <i class="fas fa-image me-1"></i>ç”»åƒã‚¿ã‚¤ãƒˆãƒ«
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="image_name" name="image_name" 
                                   value="{{ question.image_title or '' }}">
                            <button type="button" class="btn btn-outline-secondary" onclick="checkImageExists()">
                                <i class="fas fa-search"></i>ç¢ºèª
                            </button>
                        </div>
                        
                        <!-- æ—¢å­˜ã®ç”»åƒè¡¨ç¤º -->
                        {% if question.image_title %}
                        <div class="mt-2">
                            <div class="alert alert-info">
                                <i class="fas fa-image me-1"></i>
                                <strong>ç¾åœ¨ã®ç”»åƒ:</strong> 
                                <span class="badge bg-primary">{{ question.image_title }}</span>
                            </div>
                            <!-- ç¾åœ¨ã®ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                            <div id="current-image-preview" class="text-center mt-2" style="display: none;">
                                <div id="current-image-status" class="alert alert-success">
                                    <i class="fas fa-check-circle me-1"></i>
                                    <strong>ç¾åœ¨ã®ç”»åƒ:</strong>
                                </div>
                                <div id="current-image-container">
                                    <div class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="mt-2">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>ç¾åœ¨ã®ç”»åƒ:</strong> 
                                <span class="badge bg-secondary">ãªã—</span>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div id="image-preview" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-search me-1"></i>
                                <strong>ç”»åƒç¢ºèªçµæœ:</strong> 
                                <span id="image-status"></span>
                            </div>
                            <div id="image-preview-container" class="text-center">
                                <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        {% if question.unit_id %}
                            <a href="{{ url_for('social_studies_admin_unit_questions', textbook_id=question.textbook_id or 1, unit_id=question.unit_id) }}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </a>
                        {% else %}
                            <a href="{{ url_for('social_studies_admin_questions') }}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </a>
                        {% endif %}
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>æ›´æ–°
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    
    // ç¾åœ¨ã®ç”»åƒãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«è¡¨ç¤º
    {% if question.image_title %}
    showCurrentImage();
    {% endif %}
    
    // ç”»åƒç¢ºèªã¯æ‰‹å‹•ã§è¡Œã†ãŸã‚ã€è‡ªå‹•å®Ÿè¡Œã—ãªã„
    // const imageNameInput = document.getElementById('image_name');
    // if (imageNameInput && imageNameInput.value.trim()) {
    //     checkImageExists();
    // }
    
    // æ•™æã¨å˜å…ƒãŒå›ºå®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®å‡¦ç†
    {% if textbook_info and unit_info %}
        {% if image_path_info %}
        const imagePathDisplay = document.getElementById('image_path_display');
        if (imagePathDisplay) {
            imagePathDisplay.value = '{{ image_path_info.base_url }}';
        }
        {% endif %}
    {% else %}
        // é€šå¸¸ã®é¸æŠå½¢å¼ã®å ´åˆ
        {% if question.textbook_id %}
        setTimeout(function() {
            const textbookSelect = document.getElementById('textbook_id');
            if (textbookSelect) {
                textbookSelect.value = '{{ question.textbook_id }}';
                loadUnits();
            }
        }, 500);
        {% endif %}
        
        {% if question.unit_id %}
        setTimeout(function() {
            const unitSelect = document.getElementById('unit_id');
            if (unitSelect) {
                unitSelect.value = '{{ question.unit_id }}';
            }
        }, 1500);
        {% endif %}
    {% endif %}
});

function loadTextbooks() {
    const subject = document.getElementById('subject').value;
    const textbookSelect = document.getElementById('textbook_id');
    const unitSelect = document.getElementById('unit_id');
    
    unitSelect.innerHTML = '<option value="">å˜å…ƒãƒ»ç« ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
    
    if (!subject) {
        textbookSelect.innerHTML = '<option value="">æ•™æã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
        return;
    }
    
    fetch(`/social_studies/api/textbooks?subject=${subject}`)
        .then(response => response.json())
        .then(data => {
            textbookSelect.innerHTML = '<option value="">æ•™æã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
            data.forEach(textbook => {
                const option = document.createElement('option');
                option.value = textbook.id;
                option.textContent = `${textbook.name} (${textbook.subject})`;
                textbookSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('æ•™æå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        });
}

function loadUnits() {
    const textbookId = document.getElementById('textbook_id').value;
    const unitSelect = document.getElementById('unit_id');
    
    if (!textbookId) {
        unitSelect.innerHTML = '<option value="">å˜å…ƒãƒ»ç« ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
        return;
    }
    
    fetch(`/social_studies/api/units?textbook_id=${textbookId}`)
        .then(response => response.json())
        .then(data => {
            unitSelect.innerHTML = '<option value="">å˜å…ƒãƒ»ç« ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
            data.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                const chapterText = unit.chapter_number ? `ç¬¬${unit.chapter_number}ç« ` : '';
                option.textContent = `${chapterText} ${unit.name}`;
                unitSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('å˜å…ƒå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        });
}

function updatePreview() {
    const suffixInput = document.getElementById('answer_suffix');
    const previewSection = document.getElementById('preview-section');
    const previewSuffix = document.getElementById('preview-suffix');
    
    if (suffixInput.value.trim()) {
        previewSuffix.textContent = suffixInput.value.trim();
        previewSection.style.display = 'block';
    } else {
        previewSection.style.display = 'none';
    }
}

function showCurrentImage() {
    const imageTitle = '{{ question.image_title or "" }}';
    const unitId = '{{ question.unit_id or "" }}';
    const previewDiv = document.getElementById('current-image-preview');
    const statusDiv = document.getElementById('current-image-status');
    const containerDiv = document.getElementById('current-image-container');
    
    if (!imageTitle || !unitId) {
        console.log('ç”»åƒã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯å˜å…ƒIDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã¯æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®ã¿æ›´æ–°
    containerDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    fetch(`/social_studies/api/check_image?image_name=${encodeURIComponent(imageTitle)}&unit_id=${unitId}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                // ç”»åƒãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                previewDiv.style.display = 'block';
                statusDiv.className = 'alert alert-success';
                statusDiv.innerHTML = '<i class="fas fa-check-circle me-1"></i><strong>ç¾åœ¨ã®ç”»åƒ:</strong>';
                
                const img = document.createElement('img');
                img.src = data.image_url;
                img.className = 'img-fluid';
                img.style.maxHeight = '300px';
                img.style.border = '1px solid #dee2e6';
                img.style.borderRadius = '0.375rem';
                img.alt = 'ç¾åœ¨ã®ç”»åƒ';
                
                img.onerror = function() {
                    containerDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€è¡¨ç¤ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                            URL: ${data.image_url}
                        </div>
                    `;
                };
                
                img.onload = function() {
                    console.log('âœ… ç¾åœ¨ã®ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ:', data.image_url);
                };
                
                containerDiv.innerHTML = '';
                containerDiv.appendChild(img);
            } else {
                // ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€Œãªã—ã€ã¨è¡¨ç¤º
                previewDiv.style.display = 'block';
                statusDiv.className = 'alert alert-warning';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i><strong>ç¾åœ¨ã®ç”»åƒ:</strong> <span class="badge bg-secondary">ãªã—</span>';
                containerDiv.innerHTML = '';
            }
        })
        .catch(error => {
            console.error('ç¾åœ¨ã®ç”»åƒå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = '<i class="fas fa-times-circle me-1"></i><strong>ç¾åœ¨ã®ç”»åƒ:</strong> <span class="badge bg-danger">ã‚¨ãƒ©ãƒ¼</span>';
            containerDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    ç”»åƒã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}
                </div>
            `;
        });
}

function checkImageExists() {
    const imageName = document.getElementById('image_name').value.trim();
    const previewDiv = document.getElementById('image-preview');
    const statusSpan = document.getElementById('image-status');
    const containerDiv = document.getElementById('image-preview-container');
    
    // å˜å…ƒIDã‚’å–å¾—ï¼ˆå›ºå®šè¡¨ç¤ºã®å ´åˆã¯hidden inputã‹ã‚‰ã€é¸æŠã®å ´åˆã¯selectã‹ã‚‰ï¼‰
    let unitId = null;
    const unitIdElement = document.getElementById('unit_id');
    if (unitIdElement) {
        unitId = unitIdElement.value;
    }
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
    console.log('ğŸ” checkImageExists ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
    console.log('  imageName:', imageName);
    console.log('  unitIdElement:', unitIdElement);
    console.log('  unitId:', unitId);
    
    if (!imageName) {
        console.log('âŒ ç”»åƒåãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        previewDiv.style.display = 'none';
        return;
    }
    
    if (!unitId) {
        console.log('âŒ å˜å…ƒIDãŒå–å¾—ã§ãã¾ã›ã‚“');
        statusSpan.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> å˜å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„`;
        previewDiv.style.display = 'block';
        return;
    }
    
    statusSpan.innerHTML = `<i class="fas fa-spinner fa-spin text-info"></i> ç”»åƒã‚’ç¢ºèªä¸­...`;
    containerDiv.innerHTML = '';
    previewDiv.style.display = 'block';
    
    fetch(`/social_studies/api/check_image?image_name=${encodeURIComponent(imageName)}&unit_id=${unitId}`)
        .then(response => {
            console.log('ğŸ” APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('ğŸ” APIãƒ‡ãƒ¼ã‚¿:', data);
            console.log('ğŸ” APIãƒ‡ãƒ¼ã‚¿è©³ç´°:', JSON.stringify(data, null, 2));
            
            if (data.exists) {
                statusSpan.innerHTML = `<i class="fas fa-check-circle text-success"></i> ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
                
                const img = document.createElement('img');
                img.src = data.image_url;
                img.className = 'img-fluid';
                img.style.maxHeight = '200px';
                img.alt = 'ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
                
                img.onerror = function() {
                    console.error('âŒ ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', data.image_url);
                    containerDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€è¡¨ç¤ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                            URL: ${data.image_url}
                        </div>
                    `;
                };
                
                img.onload = function() {
                    console.log('âœ… ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ:', data.image_url);
                };
                
                containerDiv.innerHTML = '';
                containerDiv.appendChild(img);
            } else {
                // ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
                previewDiv.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('ç”»åƒç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            statusSpan.innerHTML = `<i class="fas fa-times-circle text-danger"></i> ç”»åƒç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ`;
            containerDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}
                </div>
            `;
            previewDiv.style.display = 'block';
        });
}

function saveQuestion(event) {
    event.preventDefault();
    
    const formData = {
        subject: document.querySelector('input[name="subject"]').value,
        textbook_id: document.querySelector('input[name="textbook_id"]').value || null,
        unit_id: document.querySelector('input[name="unit_id"]').value || null,
        question: document.getElementById('question').value.trim(),
        correct_answer: document.getElementById('correct_answer').value.trim(),
        acceptable_answers: document.getElementById('acceptable_answers').value.trim(),
        answer_suffix: document.getElementById('answer_suffix').value.trim(),
        explanation: document.getElementById('explanation').value.trim(),
        difficulty_level: document.getElementById('difficulty_level').value,
        image_name: document.getElementById('image_name').value.trim()
    };
    
    if (!formData.question) {
        alert('å•é¡Œæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    if (!formData.correct_answer) {
        alert('æ­£è§£ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const submitButton = document.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>æ›´æ–°ä¸­...';
    
    fetch('{{ url_for("social_studies_edit_question", question_id=question.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('å•é¡Œã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            // å˜å…ƒã®å•é¡Œç”»é¢ã«æˆ»ã‚‹
            {% if question.unit_id %}
                window.location.href = '{{ url_for("social_studies_admin_unit_questions", textbook_id=question.textbook_id or 1, unit_id=question.unit_id) }}';
            {% else %}
                window.location.href = '{{ url_for("social_studies_admin_questions") }}';
            {% endif %}
        }
    })
    .catch(error => {
        console.error('å•é¡Œæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('å•é¡Œã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    })
    .finally(() => {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}
</script>
{% endblock %} 