{% extends "base.html" %}

{% block title %}問題一覧 - 社会科管理{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold">
                <i class="fas fa-list me-2"></i>問題一覧
            </h2>
            <p class="text-muted">登録されている問題を管理できます</p>
        </div>
        <div>
            <a href="{{ url_for('social_studies_add_question') }}" class="btn btn-success me-2">
                <i class="fas fa-plus me-2"></i>新規追加
            </a>
            <button class="btn btn-info me-2" onclick="showCsvUpload()">
                <i class="fas fa-upload me-2"></i>CSV一括登録
            </button>
            <a href="{{ url_for('social_studies_admin') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>管理画面に戻る
            </a>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>科目</th>
                        <th>教材・単元</th>
                        <th>問題文</th>
                        <th>正解</th>
                        <th>難易度</th>
                        <th>登録日</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for question in questions %}
                    <tr>
                        <td>{{ question.id }}</td>
                        <td>
                            <span class="badge bg-primary">{{ question.subject }}</span>
                        </td>
                        <td>
                            {% if question.textbook_name %}
                                <div class="small">
                                    <strong>{{ question.textbook_name }}</strong>
                                    {% if question.unit_name %}
                                        <br><span class="text-muted">{{ question.unit_name }}</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-muted">未設定</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 250px;" title="{{ question.question }}">
                                {{ question.question }}
                            </div>
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 120px;" title="{{ question.correct_answer }}">
                                {{ question.correct_answer }}
                            </div>
                        </td>
                        <td>
                            {% if question.difficulty_level == 'basic' %}
                                <span class="badge bg-success">基本</span>
                            {% elif question.difficulty_level == 'intermediate' %}
                                <span class="badge bg-warning">中級</span>
                            {% elif question.difficulty_level == 'advanced' %}
                                <span class="badge bg-danger">上級</span>
                            {% else %}
                                <span class="badge bg-secondary">未設定</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ question.created_at.strftime('%Y/%m/%d') if question.created_at else '不明' }}
                            </small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editQuestion({{ question.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="showImageUpload({{ question.id }})">
                                <i class="fas fa-image"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion({{ question.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if not questions %}
        <div class="text-center py-5">
            <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">まだ問題が登録されていません</h4>
            <p class="text-muted">新しい問題を追加してください</p>
            <a href="{{ url_for('social_studies_add_question') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>問題を追加
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- 編集モーダル -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">問題編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="edit-subject" class="form-label">科目</label>
                        <select class="form-select" id="edit-subject" name="subject" required>
                            <option value="地理">地理</option>
                            <option value="歴史">歴史</option>
                            <option value="公民">公民</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-question" class="form-label">問題文</label>
                        <textarea class="form-control" id="edit-question" name="question" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit-correct-answer" class="form-label">正解</label>
                        <input type="text" class="form-control" id="edit-correct-answer" name="correct_answer" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-acceptable-answers" class="form-label">許容回答（カンマ区切り）</label>
                        <input type="text" class="form-control" id="edit-acceptable-answers" name="acceptable_answers" placeholder="例: 東京都, Tokyo">
                    </div>
                    <div class="mb-3">
                        <label for="edit-explanation" class="form-label">解説</label>
                        <textarea class="form-control" id="edit-explanation" name="explanation" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- CSV一括登録モーダル -->
<div class="modal fade" id="csvUploadModal" tabindex="-1" style="z-index: 1050;">
    <div class="modal-dialog modal-lg" style="z-index: 1055;">
        <div class="modal-content" style="z-index: 1060;">
            <div class="modal-header">
                <h5 class="modal-title">CSV一括登録</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>CSVファイル形式</h6>
                    <p class="mb-2">以下の列を含むCSVファイルをアップロードしてください：</p>
                    <ul class="mb-0">
                        <li><strong>subject</strong>: 科目（地理、歴史、公民）</li>
                        <li><strong>question</strong>: 問題文</li>
                        <li><strong>correct_answer</strong>: 正解</li>
                        <li><strong>acceptable_answers</strong>: 許容回答（カンマ区切り、オプション）</li>
                        <li><strong>explanation</strong>: 解説（オプション）</li>
                        <li><strong>textbook_id</strong>: 教材ID（オプション）</li>
                        <li><strong>unit_id</strong>: 単元ID（オプション）</li>
                    </ul>
                </div>
                
                    </div>
                
                <div class="mb-3">
                    <label for="csv-subject" class="form-label">デフォルト科目</label>
                    <select class="form-select" id="csv-subject">
                        <option value="">CSVファイルの科目を使用</option>
                        <option value="地理">地理</option>
                        <option value="歴史">歴史</option>
                        <option value="公民">公民</option>
                    </select>
                    <div class="form-text">CSVファイルに科目が含まれていない場合のデフォルト科目を設定</div>
                </div>
                
                <div class="mb-3">
                    <label for="csv-textbook" class="form-label">デフォルト教材</label>
                    <select class="form-select" id="csv-textbook">
                        <option value="">CSVファイルの教材IDを使用</option>
                    </select>
                    <div class="form-text">CSVファイルに教材IDが含まれていない場合のデフォルト教材を設定</div>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>注意事項</h6>
                    <ul class="mb-0">
                        <li>1行目はヘッダー行として扱われます</li>
                        <li>同じ問題文と正解の組み合わせは重複登録されません</li>
                        <li>教材IDや単元IDが存在しない場合は無視されます</li>
                        <li>最大1000件まで一括登録できます</li>
                    </ul>
                </div>
                <div class="form-text mt-2">CSVファイル <strong>social_studies_questions_sample.csv</strong>、UTF-8、Shift_JIS、CP932、EUC-JP、ISO-2022-JPエンコーディングのCSVファイルを選択してください</div>
                
                <div class="mb-3">
                    <label for="csv-file" class="form-label">CSVファイル <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="csv-file" accept=".csv" required>
                    <div class="mt-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadSampleCsv()">
                            <i class="fas fa-download me-1"></i>サンプルCSVをダウンロード
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 1rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="alert('ボタンがクリックされました'); uploadCsv();" id="csv-upload-btn" style="cursor: pointer; position: relative; z-index: 1000;">
                    <i class="fas fa-upload me-1"></i>アップロード
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 画像アップロードモーダル -->
<div class="modal fade" id="imageUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">問題画像アップロード</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>画像アップロードについて</h6>
                    <p class="mb-2">問題に関連する画像をアップロードできます。画像はWasabiクラウドストレージに保存されます。</p>
                </div>
                
                <div class="mb-3">
                    <label for="image-file" class="form-label">画像ファイル</label>
                    <div class="upload-area" id="image-upload-area">
                        <i class="fas fa-image fa-3x text-muted mb-3"></i>
                        <p class="mb-2">画像をドラッグ&ドロップまたはクリックして選択</p>
                        <input type="file" id="image-file" name="image" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('image-file').click()">
                            画像を選択
                        </button>
                    </div>
                    <div class="form-text">JPEG、PNG、GIF形式、5MB以下の画像ファイルを選択してください</div>
                </div>
                
                <div id="current-image-section" style="display: none;">
                    <h6>現在の画像</h6>
                    <div class="text-center mb-3">
                        <img id="current-image" src="" alt="現在の画像" class="img-fluid" style="max-height: 200px;">
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteCurrentImage()">
                        <i class="fas fa-trash me-1"></i>現在の画像を削除
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="uploadImage()">
                    <i class="fas fa-upload me-1"></i>アップロード
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentEditId = null;

function editQuestion(questionId) {
    currentEditId = questionId;
    
    // 問題データを取得
    fetch(`/social_studies/admin/edit_question/${questionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // モーダルのフォームにデータを設定
            document.getElementById('edit-subject').value = data.subject || '';
            document.getElementById('edit-question').value = data.question || '';
            document.getElementById('edit-correct-answer').value = data.correct_answer || '';
            document.getElementById('edit-acceptable-answers').value = data.acceptable_answers || '';
            document.getElementById('edit-explanation').value = data.explanation || '';
            
            // モーダルを表示
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        })
        .catch(error => {
            console.error('問題データ取得エラー:', error);
            alert('問題データの取得に失敗しました');
        });
}

function saveEdit() {
    if (!currentEditId) {
        alert('編集する問題が選択されていません');
        return;
    }
    
    // フォームデータを取得
    const formData = {
        subject: document.getElementById('edit-subject').value,
        question: document.getElementById('edit-question').value.trim(),
        correct_answer: document.getElementById('edit-correct-answer').value.trim(),
        acceptable_answers: document.getElementById('edit-acceptable-answers').value.trim(),
        explanation: document.getElementById('edit-explanation').value.trim()
    };
    
    // バリデーション
    if (!formData.subject) {
        alert('科目を選択してください');
        return;
    }
    if (!formData.question) {
        alert('問題文を入力してください');
        return;
    }
    if (!formData.correct_answer) {
        alert('正解を入力してください');
        return;
    }
    
    // 保存ボタンを無効化
    const saveButton = document.querySelector('#editModal .btn-primary');
    const originalText = saveButton.textContent;
    saveButton.disabled = true;
    saveButton.textContent = '保存中...';
    
    // APIに送信
    fetch(`/social_studies/admin/edit_question/${currentEditId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 成功時はモーダルを閉じてページを再読み込み
            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();
            location.reload();
        } else {
            // エラーメッセージを表示
            alert(data.error || '保存に失敗しました');
        }
    })
    .catch(error => {
        console.error('保存エラー:', error);
        alert('保存に失敗しました');
    })
    .finally(() => {
        // ボタンを元に戻す
        saveButton.disabled = false;
        saveButton.textContent = originalText;
    });
}

function deleteQuestion(questionId) {
    if (confirm('この問題を削除しますか？\nこの操作は取り消せません。')) {
        // 削除APIを呼び出し
        fetch(`/social_studies/admin/delete_question/${questionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 成功時はページを再読み込み
                location.reload();
            } else {
                // エラーメッセージを表示
                alert(data.error || '削除に失敗しました');
            }
        })
        .catch(error => {
            console.error('削除エラー:', error);
            alert('削除に失敗しました');
        });
    }
}

// CSV一括登録機能
function showCsvUpload() {
    console.log('showCsvUpload関数が呼び出されました');
    
    // 教材一覧を取得してセレクトボックスに設定
    loadTextbooksForCsv();
    
    // モーダルを表示
    const modalElement = document.getElementById('csvUploadModal');
    console.log('モーダル要素:', modalElement);
    
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        console.log('Bootstrapモーダルインスタンス:', modal);
        modal.show();
        console.log('モーダルを表示しました');
    } else {
        console.error('モーダル要素が見つかりません');
    }
}

function loadTextbooksForCsv() {
    const textbookSelect = document.getElementById('csv-textbook');
    
    // 教材を取得
    fetch('/social_studies/api/textbooks')
        .then(response => response.json())
        .then(data => {
            textbookSelect.innerHTML = '<option value="">CSVファイルの教材IDを使用</option>';
            data.forEach(textbook => {
                const option = document.createElement('option');
                option.value = textbook.id;
                option.textContent = `${textbook.name} (${textbook.subject})`;
                textbookSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('教材取得エラー:', error);
        });
}

function uploadCsv() {
    console.log('uploadCsv関数が呼び出されました');
    console.log('uploadCsv関数の呼び出し元:', new Error().stack);
    
    const fileInput = document.getElementById('csv-file');
    const defaultSubject = document.getElementById('csv-subject').value;
    const defaultTextbook = document.getElementById('csv-textbook').value;
    
    console.log('ファイル入力:', fileInput);
    console.log('デフォルト科目:', defaultSubject);
    console.log('デフォルト教材:', defaultTextbook);
    
    // ファイルチェック
    if (!fileInput.files[0]) {
        alert('CSVファイルを選択してください');
        return;
    }
    
    const file = fileInput.files[0];
    console.log('選択されたファイル:', file.name, file.size, file.type);
    
    if (!file.name.endsWith('.csv')) {
        alert('CSVファイルを選択してください');
        return;
    }
    
    // アップロードボタンを無効化
    const uploadButton = document.querySelector('#csvUploadModal .btn-primary');
    const originalText = uploadButton.textContent;
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>アップロード中...';
    
    // FormDataを作成
    const formData = new FormData();
    formData.append('file', file);
    if (defaultSubject) {
        formData.append('default_subject', defaultSubject);
    }
    if (defaultTextbook) {
        formData.append('default_textbook_id', defaultTextbook);
    }
    
    console.log('FormDataを作成:', formData);
    
    // APIに送信
    console.log('APIリクエストを送信中...');
    fetch('/social_studies/admin/upload_questions_csv', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('レスポンス受信:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('レスポンスデータ:', data);
        if (data.success) {
            // 成功時はモーダルを閉じてページを再読み込み
            const modal = bootstrap.Modal.getInstance(document.getElementById('csvUploadModal'));
            modal.hide();
            alert(`✅ ${data.message}\n登録件数: ${data.registered_count}件\nスキップ件数: ${data.skipped_count}件`);
            location.reload();
        } else {
            // エラーメッセージを表示
            alert(data.error || 'アップロードに失敗しました');
        }
    })
    .catch(error => {
        console.error('アップロードエラー:', error);
        alert('アップロードに失敗しました');
    })
    .finally(() => {
        // ボタンを元に戻す
        uploadButton.disabled = false;
        uploadButton.innerHTML = originalText;
    });
}

function downloadSampleCsv() {
    // サンプルCSVデータを作成
    const sampleData = [
        {
            subject: '地理',
            question: '日本の首都はどこですか？',
            correct_answer: '東京',
            acceptable_answers: '東京都,Tokyo',
            explanation: '日本の首都は東京都です。',
            textbook_id: '',
            unit_id: ''
        },
        {
            subject: '歴史',
            question: '織田信長が本能寺の変で倒れた年は？',
            correct_answer: '1582年',
            acceptable_answers: '天正10年',
            explanation: '1582年（天正10年）に本能寺の変が起こりました。',
            textbook_id: '',
            unit_id: ''
        },
        {
            subject: '公民',
            question: '日本の国会は何院制ですか？',
            correct_answer: '二院制',
            acceptable_answers: '2院制,両院制',
            explanation: '衆議院と参議院の二院制です。',
            textbook_id: '',
            unit_id: ''
        }
    ];
    
    // CSVヘッダー
    let csvContent = 'subject,question,correct_answer,acceptable_answers,explanation,textbook_id,unit_id\n';
    
    // サンプルデータをCSV形式に変換
    sampleData.forEach(row => {
        csvContent += `"${row.subject}","${row.question}","${row.correct_answer}","${row.acceptable_answers}","${row.explanation}","${row.textbook_id}","${row.unit_id}"\n`;
    });
    
    // ファイルをダウンロード
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'social_studies_questions_sample.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 画像アップロード機能
let currentQuestionId = null;

function showImageUpload(questionId) {
    currentQuestionId = questionId;
    
    // 現在の画像を取得
    fetch(`/social_studies/admin/question/${questionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.question.image_url) {
                document.getElementById('current-image').src = data.question.image_url;
                document.getElementById('current-image-section').style.display = 'block';
            } else {
                document.getElementById('current-image-section').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('画像取得エラー:', error);
            document.getElementById('current-image-section').style.display = 'none';
        });
    
    // モーダルを表示
    const modal = new bootstrap.Modal(document.getElementById('imageUploadModal'));
    modal.show();
}

function uploadImage() {
    const fileInput = document.getElementById('image-file');
    
    if (!fileInput.files[0]) {
        alert('画像ファイルを選択してください');
        return;
    }
    
    if (!currentQuestionId) {
        alert('問題IDが設定されていません');
        return;
    }
    
    const formData = new FormData();
    formData.append('image', fileInput.files[0]);
    
    // アップロードボタンを無効化
    const uploadButton = document.querySelector('#imageUploadModal .btn-primary');
    const originalText = uploadButton.textContent;
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>アップロード中...';
    
    fetch(`/social_studies/admin/upload_image/${currentQuestionId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('画像をアップロードしました');
            // 現在の画像を更新
            document.getElementById('current-image').src = data.image_url;
            document.getElementById('current-image-section').style.display = 'block';
            // ファイル入力をリセット
            fileInput.value = '';
        } else {
            alert(data.error || 'アップロードに失敗しました');
        }
    })
    .catch(error => {
        console.error('アップロードエラー:', error);
        alert('アップロードに失敗しました');
    })
    .finally(() => {
        // ボタンを元に戻す
        uploadButton.disabled = false;
        uploadButton.innerHTML = originalText;
    });
}

function deleteCurrentImage() {
    if (!currentQuestionId) {
        alert('問題IDが設定されていません');
        return;
    }
    
    if (confirm('現在の画像を削除しますか？')) {
        fetch(`/social_studies/admin/delete_image/${currentQuestionId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('画像を削除しました');
                document.getElementById('current-image-section').style.display = 'none';
            } else {
                alert(data.error || '削除に失敗しました');
            }
        })
        .catch(error => {
            console.error('削除エラー:', error);
            alert('削除に失敗しました');
        });
    }
}

// 画像ファイル選択時の処理
document.getElementById('image-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const uploadArea = document.getElementById('image-upload-area');
        uploadArea.innerHTML = `
            <i class="fas fa-image fa-3x text-success mb-3"></i>
            <p class="mb-2"><strong>${file.name}</strong></p>
            <p class="text-muted">画像が選択されました</p>
        `;
    }
});

// CSVファイル選択時の処理
document.getElementById('csv-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    console.log('CSVファイルが選択されました:', file);
    if (file) {
        console.log('ファイル詳細:', file.name, file.size, file.type);
    }
});

// アップロードボタンのクリックイベントを追加
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoadedイベントが発火しました');
    const uploadBtn = document.getElementById('csv-upload-btn');
    console.log('アップロードボタン要素:', uploadBtn);
    
    if (uploadBtn) {
        console.log('アップロードボタンにイベントリスナーを追加します');
        
        // ボタンの状態を確認して修正
        console.log('ボタンのdisabled状態:', uploadBtn.disabled);
        console.log('ボタンのinnerHTML:', uploadBtn.innerHTML);
        console.log('ボタンのstyle:', uploadBtn.style);
        
        // ボタンを確実に有効化
        uploadBtn.disabled = false;
        uploadBtn.style.pointerEvents = 'auto';
        uploadBtn.style.cursor = 'pointer';
        uploadBtn.style.position = 'relative';
        uploadBtn.style.zIndex = '1000';
        
        uploadBtn.addEventListener('click', function(e) {
            console.log('アップロードボタンがクリックされました');
            e.preventDefault();
            e.stopPropagation();
            uploadCsv();
        });
        
        // ボタンがクリック可能かテスト
        console.log('ボタンの最終状態:');
        console.log('- disabled:', uploadBtn.disabled);
        console.log('- pointerEvents:', uploadBtn.style.pointerEvents);
        console.log('- cursor:', uploadBtn.style.cursor);
        console.log('- zIndex:', uploadBtn.style.zIndex);
        
    } else {
        console.error('アップロードボタンが見つかりません');
    }
    
    // モーダル内のボタンも確認
    const modalUploadBtn = document.querySelector('#csvUploadModal .btn-primary');
    console.log('モーダル内のアップロードボタン:', modalUploadBtn);
    
    // モーダルが表示された時の処理を追加
    const csvModal = document.getElementById('csvUploadModal');
    if (csvModal) {
        csvModal.addEventListener('shown.bs.modal', function() {
            console.log('CSVモーダルが表示されました');
            const uploadBtnInModal = document.getElementById('csv-upload-btn');
            if (uploadBtnInModal) {
                console.log('モーダル内のアップロードボタンを確認:');
                console.log('- disabled:', uploadBtnInModal.disabled);
                console.log('- style:', uploadBtnInModal.style);
                
                // モーダル表示時にボタンを確実に有効化
                uploadBtnInModal.disabled = false;
                uploadBtnInModal.style.pointerEvents = 'auto';
                uploadBtnInModal.style.cursor = 'pointer';
            }
        });
    }
});
</script>
{% endblock %} 