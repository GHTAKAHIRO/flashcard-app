{% extends "base.html" %}

{% block title %}å•é¡Œè¿½åŠ  - ç¤¾ä¼šç§‘ç®¡ç†{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold">
                <i class="fas fa-plus me-2"></i>å•é¡Œè¿½åŠ 
            </h2>
            <p class="text-muted">
                {% if textbook_info and unit_info %}
                    {{ textbook_info.name }} - {{ unit_info.name }}
                    {% if unit_info.chapter_number %}(ç¬¬{{ unit_info.chapter_number }}ç« ){% endif %}
                {% elif textbook_info %}
                    {{ textbook_info.name }}
                {% else %}
                    æ–°ã—ã„ç¤¾ä¼šç§‘å•é¡Œã‚’è¿½åŠ ã—ã¾ã™
                {% endif %}
            </p>
        </div>
        <div>
            {% if textbook_info and unit_info %}
                <a href="{{ url_for('social_studies_admin_unit_questions', textbook_id=textbook_info.id, unit_id=unit_info.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>å˜å…ƒã«æˆ»ã‚‹
                </a>
            {% elif textbook_info %}
                <a href="{{ url_for('social_studies_admin_textbook_unified', textbook_id=textbook_info.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>å˜å…ƒç®¡ç†ã«æˆ»ã‚‹
                </a>
            {% else %}
                <a href="{{ url_for('social_studies_admin_questions') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>å•é¡Œä¸€è¦§ã«æˆ»ã‚‹
                </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    {% if textbook_info and unit_info %}
                        <!-- æ•™æã¨å˜å…ƒãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å›ºå®šè¡¨ç¤º -->
                        <div class="mb-3">
                            <label class="form-label">ç§‘ç›® <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" value="{{ textbook_info.subject or 'æœªè¨­å®š' }}" readonly>
                            <input type="hidden" name="subject" value="{{ textbook_info.subject or 'åœ°ç†' }}">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-book me-1"></i>æ•™æ
                            </label>
                            <input type="text" class="form-control" value="{{ textbook_info.name }}" readonly>
                            <input type="hidden" name="textbook_id" value="{{ textbook_info.id }}">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-list-ol me-1"></i>å˜å…ƒãƒ»ç« 
                            </label>
                            <input type="text" class="form-control" value="{{ unit_info.name }}{% if unit_info.chapter_number %} (ç¬¬{{ unit_info.chapter_number }}ç« ){% endif %}" readonly>
                            <input type="hidden" name="unit_id" value="{{ unit_info.id }}">
                        </div>
                    {% else %}
                        <!-- é€šå¸¸ã®é¸æŠå½¢å¼ -->
                        <div class="mb-3">
                            <label for="subject" class="form-label">ç§‘ç›® <span class="text-danger">*</span></label>
                            <select class="form-select" id="subject" name="subject" required onchange="loadTextbooks()">
                                <option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="åœ°ç†">åœ°ç†</option>
                                <option value="æ­´å²">æ­´å²</option>
                                <option value="å…¬æ°‘">å…¬æ°‘</option>
                                <option value="ç†ç§‘">ç†ç§‘</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="textbook_id" class="form-label">
                                <i class="fas fa-book me-1"></i>æ•™æ
                            </label>
                            <select class="form-select" id="textbook_id" name="textbook_id" onchange="loadUnits()">
                                <option value="">æ•™æã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>
                            </select>
                            <div class="form-text">å•é¡Œã«é–¢é€£ã™ã‚‹æ•™æãŒã‚ã‚Œã°é¸æŠã—ã¦ãã ã•ã„</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="unit_id" class="form-label">
                                <i class="fas fa-list-ol me-1"></i>å˜å…ƒãƒ»ç« 
                            </label>
                            <select class="form-select" id="unit_id" name="unit_id">
                                <option value="">å˜å…ƒãƒ»ç« ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>
                            </select>
                            <div class="form-text">æ•™æã‚’é¸æŠã™ã‚‹ã¨ã€é–¢é€£ã™ã‚‹å˜å…ƒãƒ»ç« ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                            <div id="selection-status" class="mt-2" style="display: none;">
                                <small class="text-info">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="status-text"></span>
                                </small>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="difficulty_level" class="form-label">é›£æ˜“åº¦</label>
                        <select class="form-select" id="difficulty_level" name="difficulty_level">
                            <option value="basic">åŸºæœ¬</option>
                            <option value="intermediate">ä¸­ç´š</option>
                            <option value="advanced">ä¸Šç´š</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="question" class="form-label">å•é¡Œæ–‡ <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="question" name="question" rows="3" 
                                  placeholder="ä¾‹: æ—¥æœ¬ã®é¦–éƒ½ã¯ã©ã“ã§ã™ã‹ï¼Ÿ" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="correct_answer" class="form-label">æ­£è§£ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="correct_answer" name="correct_answer" 
                               placeholder="ä¾‹: æ±äº¬" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="acceptable_answers" class="form-label">è¨±å®¹å›ç­”</label>
                        <input type="text" class="form-control" id="acceptable_answers" name="acceptable_answers" 
                               placeholder="ä¾‹: æ±äº¬éƒ½, Tokyoï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å…¥åŠ›å¯èƒ½ï¼‰">
                        <div class="form-text">æ­£è§£ä»¥å¤–ã§ã‚‚æ­£è§£ã¨ã—ã¦æ‰±ã„ãŸã„å›ç­”ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="answer_suffix" class="form-label">è§£ç­”æ¬„ã®å¾Œè£œè¶³</label>
                        <input type="text" class="form-control" id="answer_suffix" name="answer_suffix" 
                               placeholder="ä¾‹: å¤§é™¸ï¼ˆã€Œã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢å¤§é™¸ã€ã®å ´åˆï¼‰ã€å¹´ï¼ˆã€Œ1868å¹´ã€ã®å ´åˆï¼‰"
                               oninput="updatePreview()">
                        <div class="form-text">è§£ç­”æ¬„ã«äºˆã‚è¡¨ç¤ºã—ãŸã„è£œè¶³æƒ…å ±ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                        <div id="preview-section" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <small>
                                    <strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong> å•é¡Œæ–‡ã®ä¸‹ã«ã€Œç­”ãˆã®å¾Œã«ã€Œ<span id="preview-suffix"></span>ã€ãŒä»˜ãã¾ã™ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="explanation" class="form-label">è§£èª¬</label>
                        <textarea class="form-control" id="explanation" name="explanation" rows="2" 
                                  placeholder="å•é¡Œã®è§£èª¬ã‚„è£œè¶³æƒ…å ±ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="image_name" class="form-label">
                            <i class="fas fa-image me-1"></i>ç”»åƒå
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="image_name" name="image_name" 
                                   placeholder="{% if textbook_info and unit_info %}ä¾‹: 2ï¼ˆå•é¡Œç•ªå·ã®ã¿ï¼‰{% else %}ä¾‹: 1-2{% endif %}" 
                                   onchange="checkImageExists()">
                            <button type="button" class="btn btn-outline-secondary" onclick="checkImageExists()">
                                <i class="fas fa-search"></i>ç¢ºèª
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            {% if textbook_info and unit_info %}
                                å•é¡Œç•ªå·ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2 â†’ 1ç« ã®2ç•ªç›®ã®å•é¡Œï¼‰
                            {% else %}
                                Wasabiã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ç”»åƒã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ‹¡å¼µå­ä¸è¦ï¼‰
                            {% endif %}
                        </div>
                        <div id="image-preview" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <small>
                                    <strong>ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong> 
                                    <span id="image-status"></span>
                                    <div id="image-preview-container" class="mt-2 text-center"></div>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('social_studies_admin_questions') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>å•é¡Œã‚’è¿½åŠ 
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- å…¥åŠ›ä¾‹ -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>å…¥åŠ›ä¾‹
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>åœ°ç†ã®ä¾‹</h6>
                        <ul class="list-unstyled">
                            <li><strong>å•é¡Œ:</strong> æ—¥æœ¬ã®é¦–éƒ½ã¯ã©ã“ã§ã™ã‹ï¼Ÿ</li>
                            <li><strong>æ­£è§£:</strong> æ±äº¬</li>
                            <li><strong>è¨±å®¹å›ç­”:</strong> æ±äº¬éƒ½, Tokyo</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>æ­´å²ã®ä¾‹</h6>
                        <ul class="list-unstyled">
                            <li><strong>å•é¡Œ:</strong> æ±Ÿæˆ¸å¹•åºœã‚’é–‹ã„ãŸäººç‰©ã¯èª°ã§ã™ã‹ï¼Ÿ</li>
                            <li><strong>æ­£è§£:</strong> å¾³å·å®¶åº·</li>
                            <li><strong>è¨±å®¹å›ç­”:</strong> å¾³å·å®¶åº·å…¬, Tokugawa Ieyasu</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>ç†ç§‘ã®ä¾‹</h6>
                        <ul class="list-unstyled">
                            <li><strong>å•é¡Œ:</strong> æ°´ã®åŒ–å­¦å¼ã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
                            <li><strong>æ­£è§£:</strong> Hâ‚‚O</li>
                            <li><strong>è¨±å®¹å›ç­”:</strong> H2O, æ°´</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
document.addEventListener('DOMContentLoaded', function() {
    {% if textbook_info and unit_info %}
    // æ•™æã¨å˜å…ƒãŒå›ºå®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€å˜å…ƒã®ç« ç•ªå·ã«åŸºã¥ã„ã¦ç”»åƒãƒ‘ã‚¹æƒ…å ±ã‚’è¨­å®š
    setTimeout(function() {
        const unitId = '{{ unit_info.id }}';
        updateUnitImagePathInfo(unitId);
    }, 500);
    {% else %}
    // é€šå¸¸ã®é¸æŠå½¢å¼ã®å ´åˆ
    {% if textbook_id %}
    // æ•™æIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€æ•™æã‚’è‡ªå‹•é¸æŠ
    setTimeout(function() {
        const textbookSelect = document.getElementById('textbook_id');
        if (textbookSelect) {
            textbookSelect.value = '{{ textbook_id }}';
            loadUnits();
        }
    }, 500);
    {% endif %}
    
    {% if unit_id %}
    // å˜å…ƒIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€å˜å…ƒã‚’è¨­å®š
    setTimeout(function() {
        const unitSelect = document.getElementById('unit_id');
        if (unitSelect) {
            unitSelect.value = '{{ unit_id }}';
        }
    }, 1500); // æ•™æã¨å˜å…ƒã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
    {% endif %}
    {% endif %}
});

function loadTextbooks() {
    const subject = document.getElementById('subject').value;
    const textbookSelect = document.getElementById('textbook_id');
    const unitSelect = document.getElementById('unit_id');
    
    // å˜å…ƒã‚»ãƒ¬ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    unitSelect.innerHTML = '<option value="">å˜å…ƒãƒ»ç« ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
    
    // ç§‘ç›®ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯ç”»åƒåæ¬„ã‚‚ã‚¯ãƒªã‚¢
    clearImagePathInfo();
    
    if (!subject) {
        textbookSelect.innerHTML = '<option value="">æ•™æã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
        return;
    }
    
    // æ•™æã‚’å–å¾—
    fetch(`/social_studies/api/textbooks?subject=${subject}`)
        .then(response => response.json())
        .then(data => {
            textbookSelect.innerHTML = '<option value="">æ•™æã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
            data.forEach(textbook => {
                const option = document.createElement('option');
                option.value = textbook.id;
                option.textContent = `${textbook.name} (${textbook.subject})`;
                textbookSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('æ•™æå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        });
}

function loadUnits() {
    const textbookId = document.getElementById('textbook_id').value;
    const unitSelect = document.getElementById('unit_id');
    const statusDiv = document.getElementById('selection-status');
    const statusText = document.getElementById('status-text');
    
    if (!textbookId) {
        unitSelect.innerHTML = '<option value="">å˜å…ƒãƒ»ç« ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
        statusDiv.style.display = 'none';
        // æ•™æãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç”»åƒåæ¬„ã‚’ã‚¯ãƒªã‚¢
        clearImagePathInfo();
        return;
    }
    
    // é¸æŠã•ã‚ŒãŸæ•™æåã‚’å–å¾—
    const selectedTextbook = document.getElementById('textbook_id').options[document.getElementById('textbook_id').selectedIndex].text;
    statusText.textContent = `æ•™æã€Œ${selectedTextbook}ã€ã®å˜å…ƒãƒ»ç« ã‚’èª­ã¿è¾¼ã¿ä¸­...`;
    statusDiv.style.display = 'block';
    
                    // æ•™æã®è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆç”»åƒãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‚’å«ã‚€ï¼‰
    fetch(`/social_studies/api/textbook/${textbookId}`)
        .then(response => response.json())
        .then(textbookData => {
            if (textbookData.error) {
                console.error('æ•™æè©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', textbookData.error);
                return;
            }
            
            // ç”»åƒåæ¬„ã«ãƒ‘ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
            updateImagePathInfo(textbookData.wasabi_folder_path);
        })
        .catch(error => {
            console.error('æ•™æè©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        });
    
    // å˜å…ƒã‚’å–å¾—
    fetch(`/social_studies/api/units?textbook_id=${textbookId}`)
        .then(response => response.json())
        .then(data => {
            unitSelect.innerHTML = '<option value="">å˜å…ƒãƒ»ç« ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</option>';
            data.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                // ç« ç•ªå·ã¨å˜å…ƒåã‚’æ˜ç¢ºã«è¡¨ç¤º
                const chapterText = unit.chapter_number ? `ç¬¬${unit.chapter_number}ç« ` : '';
                option.textContent = `${chapterText} ${unit.name}`;
                unitSelect.appendChild(option);
            });
            
            // é¸æŠçŠ¶æ³ã‚’æ›´æ–°
            if (data.length > 0) {
                statusText.textContent = `æ•™æã€Œ${selectedTextbook}ã€ã‹ã‚‰ ${data.length}å€‹ã®å˜å…ƒãƒ»ç« ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
            } else {
                statusText.textContent = `æ•™æã€Œ${selectedTextbook}ã€ã«ã¯å˜å…ƒãƒ»ç« ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“`;
            }
        })
        .catch(error => {
            console.error('å˜å…ƒå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            statusText.textContent = 'å˜å…ƒãƒ»ç« ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
        });
}

// ç”»åƒåæ¬„ã«ãƒ‘ã‚¹æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function updateImagePathInfo(folderPath) {
    const imageNameInput = document.getElementById('image_name');
    const imagePreviewDiv = document.getElementById('image-preview');
    const statusSpan = document.getElementById('image-status');
    
    if (folderPath) {
        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ›´æ–°
        imageNameInput.placeholder = `ä¾‹: 1-2 (ä¿å­˜å…ˆ: ${folderPath})`;
        
        // ãƒ‘ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
        statusSpan.innerHTML = `<i class="fas fa-info-circle text-info"></i> ç”»åƒä¿å­˜å…ˆ: <code>${folderPath}</code>`;
        imagePreviewDiv.style.display = 'block';
        
        // ç”»åƒåæ¬„ã®ä¸‹ã«ãƒ‘ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
        const pathInfoDiv = document.getElementById('path-info');
        if (!pathInfoDiv) {
            const newPathInfoDiv = document.createElement('div');
            newPathInfoDiv.id = 'path-info';
            newPathInfoDiv.className = 'mt-2';
            newPathInfoDiv.innerHTML = `
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-folder-open me-1"></i>
                        <strong>ç”»åƒä¿å­˜å…ˆ:</strong> <code>${folderPath}</code><br>
                        <i class="fas fa-info-circle me-1"></i>
                        ç”»åƒåã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ç”»åƒãŒè‡ªå‹•çš„ã«æ¤œç´¢ã•ã‚Œã¾ã™
                    </small>
                </div>
            `;
            imageNameInput.parentNode.insertBefore(newPathInfoDiv, imageNameInput.nextSibling);
        } else {
            pathInfoDiv.innerHTML = `
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-folder-open me-1"></i>
                        <strong>ç”»åƒä¿å­˜å…ˆ:</strong> <code>${folderPath}</code><br>
                        <i class="fas fa-info-circle me-1"></i>
                        ç”»åƒåã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ç”»åƒãŒè‡ªå‹•çš„ã«æ¤œç´¢ã•ã‚Œã¾ã™
                    </small>
                </div>
            `;
        }
    } else {
        clearImagePathInfo();
    }
}

// å˜å…ƒIDã‹ã‚‰ç”»åƒãƒ‘ã‚¹æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
function updateUnitImagePathInfo(unitId) {
    const imageNameInput = document.getElementById('image_name');
    const imagePreviewDiv = document.getElementById('image-preview');
    const statusSpan = document.getElementById('image-status');
    
    // å˜å…ƒã®ç« ç•ªå·ã«åŸºã¥ã„ã¦ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
    fetch(`/social_studies/api/check_image?image_name=test&unit_id=${unitId}`)
        .then(response => response.json())
        .then(data => {
            if (data.folder_path) {
                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ›´æ–°ï¼ˆå•é¡Œç•ªå·ã®ã¿ï¼‰
                imageNameInput.placeholder = 'ä¾‹: 2ï¼ˆå•é¡Œç•ªå·ã®ã¿ï¼‰';
                
                // ãƒ‘ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
                statusSpan.innerHTML = `<i class="fas fa-info-circle text-info"></i> ç”»åƒä¿å­˜å…ˆ: <code>${data.folder_path}</code>`;
                imagePreviewDiv.style.display = 'block';
                
                // ç”»åƒåæ¬„ã®ä¸‹ã«ãƒ‘ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
                const pathInfoDiv = document.getElementById('path-info');
                if (!pathInfoDiv) {
                    const newPathInfoDiv = document.createElement('div');
                    newPathInfoDiv.id = 'path-info';
                    newPathInfoDiv.className = 'mt-2';
                    newPathInfoDiv.innerHTML = `
                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-folder-open me-1"></i>
                                <strong>ç”»åƒä¿å­˜å…ˆ:</strong> <code>${data.folder_path}</code><br>
                                <i class="fas fa-info-circle me-1"></i>
                                å•é¡Œç•ªå·ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2 â†’ ${data.folder_path}/2.jpgï¼‰
                            </small>
                        </div>
                    `;
                    imageNameInput.parentNode.insertBefore(newPathInfoDiv, imageNameInput.nextSibling);
                } else {
                    pathInfoDiv.innerHTML = `
                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-folder-open me-1"></i>
                                <strong>ç”»åƒä¿å­˜å…ˆ:</strong> <code>${data.folder_path}</code><br>
                                <i class="fas fa-info-circle me-1"></i>
                                å•é¡Œç•ªå·ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2 â†’ ${data.folder_path}/2.jpgï¼‰
                            </small>
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('å˜å…ƒç”»åƒãƒ‘ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        });
}

// ç”»åƒåæ¬„ã®ãƒ‘ã‚¹æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
function clearImagePathInfo() {
    const imageNameInput = document.getElementById('image_name');
    const imagePreviewDiv = document.getElementById('image-preview');
    const statusSpan = document.getElementById('image-status');
    
    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å…ƒã«æˆ»ã™
    imageNameInput.placeholder = 'ä¾‹: 1-2';
    
    // ãƒ‘ã‚¹æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
    statusSpan.innerHTML = '';
    imagePreviewDiv.style.display = 'none';
    
    // ãƒ‘ã‚¹æƒ…å ±è¡¨ç¤ºã‚’å‰Šé™¤
    const pathInfoDiv = document.getElementById('path-info');
    if (pathInfoDiv) {
        pathInfoDiv.remove();
    }
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°æ©Ÿèƒ½
function updatePreview() {
    const suffixInput = document.getElementById('answer_suffix');
    const previewSection = document.getElementById('preview-section');
    const previewSuffix = document.getElementById('preview-suffix');
    
    if (suffixInput.value.trim()) {
        previewSuffix.textContent = suffixInput.value.trim();
        previewSection.style.display = 'block';
    } else {
        previewSection.style.display = 'none';
    }
}

// ç”»åƒå­˜åœ¨ç¢ºèªæ©Ÿèƒ½
function checkImageExists() {
    const imageName = document.getElementById('image_name').value.trim();
    const previewDiv = document.getElementById('image-preview');
    const statusSpan = document.getElementById('image-status');
    const containerDiv = document.getElementById('image-preview-container');
    
    // å˜å…ƒIDã‚’å–å¾—ï¼ˆå›ºå®šè¡¨ç¤ºã®å ´åˆã¯hidden inputã‹ã‚‰ã€é¸æŠã®å ´åˆã¯selectã‹ã‚‰ï¼‰
    const unitIdElement = document.getElementById('unit_id');
    const unitId = unitIdElement ? unitIdElement.value : null;
    
    console.log('ğŸ” ç”»åƒç¢ºèªé–‹å§‹:', { imageName, unitId: unitId });
    
    if (!imageName) {
        previewDiv.style.display = 'none';
        return;
    }
    
    // å˜å…ƒIDãŒå–å¾—ã§ããªã„å ´åˆ
    if (!unitId) {
        statusSpan.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> å˜å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„`;
        previewDiv.style.display = 'block';
        return;
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    statusSpan.innerHTML = `<i class="fas fa-spinner fa-spin text-info"></i> ç”»åƒã‚’ç¢ºèªä¸­...`;
    containerDiv.innerHTML = '';
    previewDiv.style.display = 'block';
    
    // ç”»åƒå­˜åœ¨ç¢ºèªAPIã‚’å‘¼ã³å‡ºã—
    fetch(`/social_studies/api/check_image?image_name=${encodeURIComponent(imageName)}&unit_id=${unitId}`)
        .then(response => {
            console.log('ğŸ” APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('ğŸ” APIãƒ‡ãƒ¼ã‚¿:', data);
            
            if (data.exists) {
                statusSpan.innerHTML = `<i class="fas fa-check-circle text-success"></i> ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
                
                // ç”»åƒè¦ç´ ã‚’ä½œæˆ
                const img = document.createElement('img');
                img.src = data.image_url;
                img.className = 'img-fluid';
                img.style.maxHeight = '200px';
                img.alt = 'ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
                
                // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                img.onerror = function() {
                    console.error('âŒ ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', data.image_url);
                    containerDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€è¡¨ç¤ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                            URL: ${data.image_url}
                        </div>
                    `;
                };
                
                // ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ
                img.onload = function() {
                    console.log('âœ… ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ:', data.image_url);
                };
                
                containerDiv.innerHTML = '';
                containerDiv.appendChild(img);
            } else {
                statusSpan.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> ${data.message || 'ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'}`;
                containerDiv.innerHTML = '';
            }
            previewDiv.style.display = 'block';
        })
        .catch(error => {
            console.error('âŒ ç”»åƒç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            statusSpan.innerHTML = `<i class="fas fa-times-circle text-danger"></i> ç”»åƒç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ`;
            containerDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}
                </div>
            `;
            previewDiv.style.display = 'block';
        });
}

// å…¨è§’æ–‡å­—ã‚’åŠè§’ã«è‡ªå‹•å¤‰æ›ã™ã‚‹æ©Ÿèƒ½ï¼ˆIMEé‡è¤‡å…¥åŠ›ã‚’é˜²ããŸã‚ã€bluræ™‚ã®ã¿å®Ÿè¡Œï¼‰
function normalizeInput(input) {
    let value = input.value;
    
    // å…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›
    value = value.replace(/[ï¼-ï¼™]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
    
    // å…¨è§’è‹±å­—ã‚’åŠè§’ã«å¤‰æ›
    value = value.replace(/[ï¼¡-ï¼ºï½-ï½š]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
    
    // å…¨è§’è¨˜å·ã‚’åŠè§’ã«å¤‰æ›
    const fullwidthSymbols = {
        'ï¼': '!', 'ï¼ ': '@', 'ï¼ƒ': '#', 'ï¼„': '$', 'ï¼…': '%', 'ï¼¾': '^', 'ï¼†': '&', 'ï¼Š': '*',
        'ï¼ˆ': '(', 'ï¼‰': ')', 'ï¼¿': '_', 'ï¼‹': '+', 'ï¼': '-', 'ï¼': '=', 'ï½›': '{', 'ï½': '}',
        'ï½œ': '|', 'ï¼š': ':', 'ï¼›': ';', 'ï¼‚': '"', 'ï¼‡': "'", 'ï¼œ': '<', 'ï¼': '>', 'ï¼Ÿ': '?',
        'ã€': ',', 'ã€‚': '.', 'ãƒ»': 'Â·', 'ï½': '~', 'ã€€': ' '
    };
    
    for (let full in fullwidthSymbols) {
        value = value.replace(new RegExp(full, 'g'), fullwidthSymbols[full]);
    }
    
    input.value = value;
}

// ã™ã¹ã¦ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›æ©Ÿèƒ½ã‚’è¿½åŠ ï¼ˆIMEé‡è¤‡å…¥åŠ›ã‚’é˜²ããŸã‚ã€bluræ™‚ã®ã¿å®Ÿè¡Œï¼‰
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[type="text"], textarea');
    inputs.forEach(input => {
        // IMEé‡è¤‡å…¥åŠ›ã‚’é˜²ããŸã‚ã€bluræ™‚ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ï¼‰ã®ã¿å¤‰æ›ã‚’å®Ÿè¡Œ
        input.addEventListener('blur', function() {
            normalizeInput(this);
        });
    });
    
    // å˜å…ƒé¸æŠæ™‚ã®çŠ¶æ³è¡¨ç¤º
    document.getElementById('unit_id').addEventListener('change', function() {
        const unitId = this.value;
        const statusDiv = document.getElementById('selection-status');
        const statusText = document.getElementById('status-text');
        
        if (unitId) {
            const selectedUnit = this.options[this.selectedIndex].text;
            statusText.textContent = `é¸æŠä¸­: ${selectedUnit}`;
            statusDiv.style.display = 'block';
        } else {
            statusDiv.style.display = 'none';
        }
    });
});
</script>
{% endblock %} 