{% extends "base.html" %}

{% block title %}問題追加 - 社会科管理{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold">
                <i class="fas fa-plus me-2"></i>問題追加
            </h2>
            <p class="text-muted">新しい社会科問題を追加します</p>
        </div>
        <a href="{{ url_for('social_studies_admin_questions') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>問題一覧に戻る
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="subject" class="form-label">科目 <span class="text-danger">*</span></label>
                        <select class="form-select" id="subject" name="subject" required onchange="loadTextbooks()">
                            <option value="">科目を選択してください</option>
                            <option value="地理">地理</option>
                            <option value="歴史">歴史</option>
                            <option value="公民">公民</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="textbook_id" class="form-label">
                            <i class="fas fa-book me-1"></i>教材
                        </label>
                        <select class="form-select" id="textbook_id" name="textbook_id" onchange="loadUnits()">
                            <option value="">教材を選択してください（オプション）</option>
                        </select>
                        <div class="form-text">問題に関連する教材があれば選択してください</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="unit_id" class="form-label">
                            <i class="fas fa-list-ol me-1"></i>単元・章
                        </label>
                        <select class="form-select" id="unit_id" name="unit_id">
                            <option value="">単元・章を選択してください（オプション）</option>
                        </select>
                        <div class="form-text">教材を選択すると、関連する単元・章が表示されます</div>
                        <div id="selection-status" class="mt-2" style="display: none;">
                            <small class="text-info">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="status-text"></span>
                            </small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="difficulty_level" class="form-label">難易度</label>
                        <select class="form-select" id="difficulty_level" name="difficulty_level">
                            <option value="basic">基本</option>
                            <option value="intermediate">中級</option>
                            <option value="advanced">上級</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="question" class="form-label">問題文 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="question" name="question" rows="3" 
                                  placeholder="例: 日本の首都はどこですか？" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="correct_answer" class="form-label">正解 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="correct_answer" name="correct_answer" 
                               placeholder="例: 東京" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="acceptable_answers" class="form-label">許容回答</label>
                        <input type="text" class="form-control" id="acceptable_answers" name="acceptable_answers" 
                               placeholder="例: 東京都, Tokyo（カンマ区切りで複数入力可能）">
                        <div class="form-text">正解以外でも正解として扱いたい回答があれば入力してください</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="answer_suffix" class="form-label">解答欄の後補足</label>
                        <input type="text" class="form-control" id="answer_suffix" name="answer_suffix" 
                               placeholder="例: 大陸（「オーストラリア大陸」の場合）、年（「1868年」の場合）">
                        <div class="form-text">解答欄に予め表示したい補足情報があれば入力してください</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="explanation" class="form-label">解説</label>
                        <textarea class="form-control" id="explanation" name="explanation" rows="2" 
                                  placeholder="問題の解説や補足情報があれば入力してください"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('social_studies_admin_questions') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-1"></i>キャンセル
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>問題を追加
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 入力例 -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>入力例
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>地理の例</h6>
                        <ul class="list-unstyled">
                            <li><strong>問題:</strong> 日本の首都はどこですか？</li>
                            <li><strong>正解:</strong> 東京</li>
                            <li><strong>許容回答:</strong> 東京都, Tokyo</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>歴史の例</h6>
                        <ul class="list-unstyled">
                            <li><strong>問題:</strong> 江戸幕府を開いた人物は誰ですか？</li>
                            <li><strong>正解:</strong> 徳川家康</li>
                            <li><strong>許容回答:</strong> 徳川家康公, Tokugawa Ieyasu</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadTextbooks() {
    const subject = document.getElementById('subject').value;
    const textbookSelect = document.getElementById('textbook_id');
    const unitSelect = document.getElementById('unit_id');
    
    // 単元セレクトをリセット
    unitSelect.innerHTML = '<option value="">単元・章を選択してください（オプション）</option>';
    
    if (!subject) {
        textbookSelect.innerHTML = '<option value="">教材を選択してください（オプション）</option>';
        return;
    }
    
    // 教材を取得
    fetch(`/social_studies/api/textbooks?subject=${subject}`)
        .then(response => response.json())
        .then(data => {
            textbookSelect.innerHTML = '<option value="">教材を選択してください（オプション）</option>';
            data.forEach(textbook => {
                const option = document.createElement('option');
                option.value = textbook.id;
                option.textContent = `${textbook.name} (${textbook.subject})`;
                textbookSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('教材取得エラー:', error);
        });
}

function loadUnits() {
    const textbookId = document.getElementById('textbook_id').value;
    const unitSelect = document.getElementById('unit_id');
    const statusDiv = document.getElementById('selection-status');
    const statusText = document.getElementById('status-text');
    
    if (!textbookId) {
        unitSelect.innerHTML = '<option value="">単元・章を選択してください（オプション）</option>';
        statusDiv.style.display = 'none';
        return;
    }
    
    // 選択された教材名を取得
    const selectedTextbook = document.getElementById('textbook_id').options[document.getElementById('textbook_id').selectedIndex].text;
    statusText.textContent = `教材「${selectedTextbook}」の単元・章を読み込み中...`;
    statusDiv.style.display = 'block';
    
    // 単元を取得
    fetch(`/social_studies/api/units?textbook_id=${textbookId}`)
        .then(response => response.json())
        .then(data => {
            unitSelect.innerHTML = '<option value="">単元・章を選択してください（オプション）</option>';
            data.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                // 章番号と単元名を明確に表示
                const chapterText = unit.chapter_number ? `第${unit.chapter_number}章` : '';
                option.textContent = `${chapterText} ${unit.name}`;
                unitSelect.appendChild(option);
            });
            
            // 選択状況を更新
            if (data.length > 0) {
                statusText.textContent = `教材「${selectedTextbook}」から ${data.length}個の単元・章が見つかりました`;
            } else {
                statusText.textContent = `教材「${selectedTextbook}」には単元・章が登録されていません`;
            }
        })
        .catch(error => {
            console.error('単元取得エラー:', error);
            statusText.textContent = '単元・章の取得に失敗しました';
        });
}

// 全角文字を半角に自動変換する機能
function normalizeInput(input) {
    let value = input.value;
    
    // 全角数字を半角に変換
    value = value.replace(/[０-９]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
    
    // 全角英字を半角に変換
    value = value.replace(/[Ａ-Ｚａ-ｚ]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
    
    // 全角記号を半角に変換
    const fullwidthSymbols = {
        '！': '!', '＠': '@', '＃': '#', '＄': '$', '％': '%', '＾': '^', '＆': '&', '＊': '*',
        '（': '(', '）': ')', '＿': '_', '＋': '+', '－': '-', '＝': '=', '｛': '{', '｝': '}',
        '｜': '|', '：': ':', '；': ';', '＂': '"', '＇': "'", '＜': '<', '＞': '>', '？': '?',
        '、': ',', '。': '.', '・': '·', '～': '~', '　': ' '
    };
    
    for (let full in fullwidthSymbols) {
        value = value.replace(new RegExp(full, 'g'), fullwidthSymbols[full]);
    }
    
    input.value = value;
}

// すべての入力フィールドに変換機能を追加
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[type="text"], textarea');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            normalizeInput(this);
        });
        
        // フォーカス時にも変換
        input.addEventListener('focus', function() {
            normalizeInput(this);
        });
    });
    
    // 単元選択時の状況表示
    document.getElementById('unit_id').addEventListener('change', function() {
        const unitId = this.value;
        const statusDiv = document.getElementById('selection-status');
        const statusText = document.getElementById('status-text');
        
        if (unitId) {
            const selectedUnit = this.options[this.selectedIndex].text;
            statusText.textContent = `選択中: ${selectedUnit}`;
            statusDiv.style.display = 'block';
        } else {
            statusDiv.style.display = 'none';
        }
    });
});
</script>
{% endblock %} 