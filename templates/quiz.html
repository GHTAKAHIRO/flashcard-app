{% extends "base.html" %}

{% block title %}{{ subject }}クイズ - 社会科一問一答アプリ{% endblock %}

{% block extra_css %}
<style>
    .quiz-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .question-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 20px;
    }
    
    .question-number {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 20px;
    }
    
    .question-text {
        font-size: 1.2em;
        font-weight: 500;
        margin-bottom: 25px;
        line-height: 1.6;
    }
    
    .answer-input {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        font-size: 1.1em;
        width: 100%;
        transition: all 0.3s ease;
    }
    
    .answer-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
    }
    
    .submit-btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        color: white;
        font-weight: bold;
        font-size: 1.1em;
        transition: all 0.3s ease;
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .submit-btn:disabled {
        opacity: 0.6;
        transform: none;
        box-shadow: none;
    }
    
    .result-card {
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        animation: slideIn 0.3s ease;
    }
    
    .result-correct {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .result-incorrect {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .progress-bar {
        background: linear-gradient(45deg, #667eea, #764ba2);
        height: 8px;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .stats-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .next-btn {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        color: white;
        font-weight: bold;
        font-size: 1.1em;
        transition: all 0.3s ease;
    }
    
    .next-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="quiz-container">
    <!-- ヘッダー -->
    <div class="text-center mb-4">
        <h2 class="fw-bold">
            <i class="fas fa-{% if subject == '地理' %}map-marked-alt{% elif subject == '歴史' %}landmark{% elif subject == '公民' %}balance-scale{% else %}book{% endif %} me-2"></i>
            {{ subject }}クイズ
        </h2>
        <p class="text-muted">問題を読んで、答えを入力してください</p>
    </div>

    <!-- 統計情報 -->
    <div class="stats-card">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="h4 text-primary mb-1" id="current-question">1</div>
                <small class="text-muted">現在の問題</small>
            </div>
            <div class="col-md-3">
                <div class="h4 text-success mb-1" id="correct-count">0</div>
                <small class="text-muted">正答数</small>
            </div>
            <div class="col-md-3">
                <div class="h4 text-danger mb-1" id="incorrect-count">0</div>
                <small class="text-muted">誤答数</small>
            </div>
            <div class="col-md-3">
                <div class="h4 text-info mb-1" id="accuracy">0%</div>
                <small class="text-muted">正答率</small>
            </div>
        </div>
        <div class="progress mt-3" style="height: 8px;">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <!-- 問題表示エリア -->
    <div id="question-area">
        {% for question in questions %}
        <div class="question-card" id="question-{{ loop.index }}" style="display: {{ 'block' if loop.index == 1 else 'none' }};">
            <div class="question-number">{{ loop.index }}</div>
            <div class="question-text">{{ question.question }}</div>
            
            <div class="mb-3">
                <input type="text" 
                       class="answer-input" 
                       id="answer-{{ loop.index }}" 
                       placeholder="答えを入力してください..."
                       data-question-id="{{ question.id }}">
            </div>
            
            <div class="text-center">
                <button class="submit-btn" onclick="submitAnswer({{ loop.index }})">
                    <i class="fas fa-paper-plane me-2"></i>回答する
                </button>
            </div>
            
            <!-- 結果表示エリア -->
            <div id="result-{{ loop.index }}" class="result-card" style="display: none;"></div>
        </div>
        {% endfor %}
    </div>

    <!-- 完了メッセージ -->
    <div id="completion-message" class="text-center" style="display: none;">
        <div class="card">
            <div class="card-body">
                <i class="fas fa-trophy fa-3x text-warning mb-3"></i>
                <h3 class="fw-bold">クイズ完了！</h3>
                <p class="lead">お疲れさまでした！</p>
                <div class="row text-center mb-4">
                    <div class="col-md-4">
                        <div class="h4 text-success" id="final-correct">0</div>
                        <small class="text-muted">正答数</small>
                    </div>
                    <div class="col-md-4">
                        <div class="h4 text-danger" id="final-incorrect">0</div>
                        <small class="text-muted">誤答数</small>
                    </div>
                    <div class="col-md-4">
                        <div class="h4 text-info" id="final-accuracy">0%</div>
                        <small class="text-muted">正答率</small>
                    </div>
                </div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary me-2">
                    <i class="fas fa-home me-1"></i>ダッシュボードに戻る
                </a>
                <a href="{{ url_for('quiz', subject=subject) }}" class="btn btn-outline-primary">
                    <i class="fas fa-redo me-1"></i>もう一度挑戦
                </a>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuestionIndex = 1;
let totalQuestions = {{ questions|length }};
let correctCount = 0;
let incorrectCount = 0;
let answeredQuestions = new Set();

// 問題データ
const questions = {{ questions|tojson|safe }};

function updateStats() {
    document.getElementById('current-question').textContent = currentQuestionIndex;
    document.getElementById('correct-count').textContent = correctCount;
    document.getElementById('incorrect-count').textContent = incorrectCount;
    
    const totalAnswered = correctCount + incorrectCount;
    const accuracy = totalAnswered > 0 ? Math.round((correctCount / totalAnswered) * 100) : 0;
    document.getElementById('accuracy').textContent = accuracy + '%';
    
    const progress = (currentQuestionIndex - 1) / totalQuestions * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
}

function submitAnswer(questionIndex) {
    const answerInput = document.getElementById(`answer-${questionIndex}`);
    const answer = answerInput.value.trim();
    
    if (!answer) {
        alert('答えを入力してください');
        return;
    }
    
    if (answeredQuestions.has(questionIndex)) {
        return; // 既に回答済み
    }
    
    const questionId = answerInput.dataset.questionId;
    const submitBtn = answerInput.parentElement.nextElementSibling.querySelector('.submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>送信中...';
    
    // サーバーに回答を送信
    fetch('/submit_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: questionId,
            answer: answer
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('エラーが発生しました: ' + data.error);
            return;
        }
        
        showResult(questionIndex, data.is_correct, data.message, data.correct_answer, answer);
        answeredQuestions.add(questionIndex);
        
        if (data.is_correct) {
            correctCount++;
        } else {
            incorrectCount++;
        }
        
        updateStats();
        
        // 次の問題に進むか、完了メッセージを表示
        setTimeout(() => {
            if (currentQuestionIndex < totalQuestions) {
                nextQuestion();
            } else {
                showCompletion();
            }
        }, 2000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>回答する';
    });
}

function showResult(questionIndex, isCorrect, message, correctAnswer, userAnswer) {
    const resultDiv = document.getElementById(`result-${questionIndex}`);
    const questionCard = document.getElementById(`question-${questionIndex}`);
    
    resultDiv.className = `result-card ${isCorrect ? 'result-correct' : 'result-incorrect'}`;
    
    let resultHtml = `
        <div class="d-flex align-items-center mb-2">
            <i class="fas fa-${isCorrect ? 'check-circle' : 'times-circle'} fa-2x me-3"></i>
            <h5 class="mb-0">${isCorrect ? '正解！' : '不正解'}</h5>
        </div>
        <p><strong>あなたの答え:</strong> ${userAnswer}</p>
        <p><strong>正解:</strong> ${correctAnswer}</p>
        <p><strong>判定:</strong> ${message}</p>
    `;
    
    resultDiv.innerHTML = resultHtml;
    resultDiv.style.display = 'block';
    
    // 入力フィールドを無効化
    const answerInput = document.getElementById(`answer-${questionIndex}`);
    answerInput.disabled = true;
}

function nextQuestion() {
    // 現在の問題を非表示
    document.getElementById(`question-${currentQuestionIndex}`).style.display = 'none';
    
    // 次の問題を表示
    currentQuestionIndex++;
    document.getElementById(`question-${currentQuestionIndex}`).style.display = 'block';
    
    // 次の問題の入力フィールドにフォーカス
    document.getElementById(`answer-${currentQuestionIndex}`).focus();
}

function showCompletion() {
    document.getElementById('question-area').style.display = 'none';
    document.getElementById('completion-message').style.display = 'block';
    
    document.getElementById('final-correct').textContent = correctCount;
    document.getElementById('final-incorrect').textContent = incorrectCount;
    
    const totalAnswered = correctCount + incorrectCount;
    const accuracy = totalAnswered > 0 ? Math.round((correctCount / totalAnswered) * 100) : 0;
    document.getElementById('final-accuracy').textContent = accuracy + '%';
}

// Enterキーで回答送信
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const activeInput = document.activeElement;
        if (activeInput && activeInput.classList.contains('answer-input')) {
            const questionIndex = activeInput.id.split('-')[1];
            submitAnswer(parseInt(questionIndex));
        }
    }
});

// 初期化
updateStats();
document.getElementById('answer-1').focus();
</script>
{% endblock %} 