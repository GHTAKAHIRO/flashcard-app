{% extends "base.html" %}

{% block title %}入力問題学習 - {{ textbook_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- ヘッダー -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-edit text-primary me-2"></i>{{ textbook_name }}
                    </h2>
                    <p class="text-muted mb-0">{{ subject }} - 入力問題学習</p>
                </div>
                <div class="text-end">
                    <div class="progress-info">
                        <span class="badge bg-primary">{{ current_index }} / {{ total_questions }}</span>
                    </div>
                    <div class="progress mt-2" style="width: 100px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ (current_index / total_questions) * 100 }}%"></div>
                    </div>
                </div>
            </div>

            <!-- 問題カード -->
            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h4 class="fw-bold">{{ question.question }}</h4>
                        {% if question.image_url %}
                        <div class="mt-3">
                            <img src="{{ question.image_url }}" alt="問題画像" class="img-fluid rounded" 
                                 style="max-width: 100%; max-height: 400px; object-fit: contain;">
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- 回答入力フォーム -->
                    <div class="answer-section">
                        <form id="answerForm">
                            <div class="form-group">
                                <div class="input-group input-group-lg">
                                    <input type="text" class="form-control" 
                                           id="answerInput" 
                                           placeholder="答えを入力してください..."
                                           autocomplete="off"
                                           autocorrect="off"
                                           autocapitalize="off"
                                           spellcheck="false">
                                    {% if question.answer_suffix %}
                                    <span class="input-group-text">{{ question.answer_suffix }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-check me-2"></i>回答する
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 結果表示エリア -->
            <div id="resultArea" style="display: none;">
                <div class="card mt-3">
                    <div class="card-body">
                        <div id="resultContent"></div>
                        <div class="text-center mt-3">
                            <button id="nextButton" class="btn btn-success btn-lg" style="display: none;">
                                <i class="fas fa-arrow-right me-2"></i>次の問題
                            </button>
                            <a id="completeButton" href="#" class="btn btn-success btn-lg" style="display: none;">
                                <i class="fas fa-trophy me-2"></i>学習完了
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ナビゲーション -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('study.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>ダッシュボードに戻る
                </a>
                <div class="text-muted">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        キーボードで答えを入力してください
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('answerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    var answer = document.getElementById('answerInput').value.trim();
    if (!answer) {
        alert('答えを入力してください');
        return;
    }
    
    // 回答ボタンを無効化
    var submitButton = document.querySelector('#answerForm button[type="submit"]');
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>送信中...';
    
    // 回答を送信
    fetch('/study/submit_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            answer: answer,
            question_id: {{ question.id }},
            study_type: 'input'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        
        // 結果を表示
        showResult(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました');
    })
    .finally(() => {
        // ボタンを復元
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-check me-2"></i>回答する';
    });
});

function showResult(data) {
    var resultArea = document.getElementById('resultArea');
    var resultContent = document.getElementById('resultContent');
    var nextButton = document.getElementById('nextButton');
    var completeButton = document.getElementById('completeButton');
    
    // 結果内容を設定
    var resultHtml = '';
    if (data.is_correct) {
        resultHtml = `
            <div class="text-center">
                <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                <h4 class="text-success">正解です！</h4>
                <p class="text-muted">素晴らしいです！</p>
            </div>
        `;
    } else {
        resultHtml = `
            <div class="text-center">
                <i class="fas fa-times-circle text-danger fa-3x mb-3"></i>
                <h4 class="text-danger">不正解です</h4>
                <p class="text-muted">正解: <strong>${data.correct_answer}</strong></p>
            </div>
        `;
    }
    
    if (data.explanation) {
        resultHtml += `
            <div class="mt-3">
                <h6>解説:</h6>
                <p class="text-muted">${data.explanation}</p>
            </div>
        `;
    }
    
    resultContent.innerHTML = resultHtml;
    
    // ボタンを表示
    if (data.is_complete) {
        completeButton.style.display = 'inline-block';
        completeButton.href = '/study/complete_study/{{ session.get("input_study_session", {}).get("session_id", 0) }}';
    } else {
        nextButton.style.display = 'inline-block';
    }
    
    resultArea.style.display = 'block';
    
    // 入力フィールドを無効化
    document.getElementById('answerInput').disabled = true;
}

document.getElementById('nextButton').addEventListener('click', function() {
    window.location.reload();
});

// Enterキーで回答
document.getElementById('answerInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('answerForm').dispatchEvent(new Event('submit'));
    }
});
</script>

<style>
.progress {
    height: 8px;
}

.progress-bar {
    transition: width 0.3s ease;
}

.answer-section {
    max-width: 500px;
    margin: 0 auto;
}

#resultArea {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %} 