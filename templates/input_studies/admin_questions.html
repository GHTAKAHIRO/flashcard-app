{% extends "base.html" %}

{% block title %}問題一覧 - 社会科管理{% endblock %}

{% block extra_css %}
<style>
    /* 問題一覧ページ専用のスタイル */
    .main-container {
        max-width: 1400px !important;
        width: 95% !important;
    }
    
    /* テーブルの横幅を最適化 */
    .table-responsive {
        overflow-x: auto;
        border-radius: 10px;
    }
    
    /* テーブルセルの余白を調整 */
    .table th, .table td {
        padding: 12px 8px;
        vertical-align: middle;
    }
    
    /* 問題文の表示を改善 */
    .question-text {
        max-width: 380px;
        word-wrap: break-word;
        line-height: 1.4;
    }
    
    /* 正解の表示を改善 */
    .answer-text {
        max-width: 130px;
        word-wrap: break-word;
        line-height: 1.3;
    }
    
    /* 操作ボタンの配置を改善 */
    .action-buttons {
        white-space: nowrap;
    }
    
    .action-buttons .btn {
        margin: 0 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold">
                <i class="fas fa-list me-2"></i>問題一覧
            </h2>
            <p class="text-muted">登録されている問題を管理できます</p>
        </div>
        <div>
            <button class="btn btn-danger me-2" id="bulk-delete-btn" style="display: none;" onclick="bulkDeleteQuestions()">
                <i class="fas fa-trash me-2"></i>選択削除
            </button>
            <a href="{{ url_for('admin.input_studies_add_question') }}" class="btn btn-success me-2">
                <i class="fas fa-plus me-2"></i>新規追加
            </a>
            <button class="btn btn-info me-2" onclick="showCsvUpload()">
                <i class="fas fa-upload me-2"></i>CSV一括登録
            </button>
            <a href="{{ url_for('admin.input_studies_admin_unified') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>管理画面に戻る
            </a>
        </div>
    </div>
</div>

<!-- フィルターセクション -->
<div class="card mb-3">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-filter me-2"></i>フィルター
        </h6>
    </div>
    <div class="card-body">
        <form id="filter-form" method="GET">
            <div class="row">
                <div class="col-md-3">
                    <label for="filter-subject" class="form-label">科目</label>
                    <select class="form-select" id="filter-subject" name="subject" onchange="loadFilterTextbooks()">
                        <option value="">全ての科目</option>
                        <option value="地理">地理</option>
                        <option value="歴史">歴史</option>
                        <option value="公民">公民</option>
                        <option value="理科">理科</option>
                        <option value="英語">英語</option>
                        <option value="数学">数学</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter-textbook" class="form-label">教材</label>
                    <select class="form-select" id="filter-textbook" name="textbook_id" onchange="loadFilterUnits()">
                        <option value="">全ての教材</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter-unit" class="form-label">単元・章</label>
                    <select class="form-select" id="filter-unit" name="unit_id">
                        <option value="">全ての単元・章</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter-difficulty" class="form-label">難易度</label>
                    <select class="form-select" id="filter-difficulty" name="difficulty">
                        <option value="">全ての難易度</option>
                        <option value="basic">基本</option>
                        <option value="intermediate">中級</option>
                        <option value="advanced">上級</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <label for="filter-search" class="form-label">キーワード検索</label>
                    <input type="text" class="form-control" id="filter-search" name="search" 
                           placeholder="問題文や正解で検索..." value="{{ request.args.get('search', '') }}">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>検索
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>クリア
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" style="min-width: 1300px;">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" id="select-all" class="form-check-input" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 60px;">ID</th>
                        <th style="width: 80px;">科目</th>
                        <th style="width: 100px;">問題タイプ</th>
                        <th style="width: 150px;">教材・単元</th>
                        <th style="width: 400px;">問題文</th>
                        <th style="width: 150px;">正解</th>
                        <th style="width: 80px;">難易度</th>
                        <th style="width: 100px;">登録日</th>
                        <th style="width: 120px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for question in questions %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input question-checkbox" value="{{ question.id }}" onchange="updateBulkDeleteButton()">
                        </td>
                        <td>{{ question.id }}</td>
                        <td>
                            <span class="badge bg-primary">{{ question.subject }}</span>
                        </td>
                        <td>
                            {% if question.question_type == '選択問題' %}
                                <span class="badge bg-info">
                                    <i class="fas fa-list me-1"></i>選択問題
                                </span>
                            {% else %}
                                <span class="badge bg-success">
                                    <i class="fas fa-edit me-1"></i>入力問題
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if question.textbook_name %}
                                <div class="small">
                                    <strong>{{ question.textbook_name }}</strong>
                                    {% if question.unit_name %}
                                        <br><span class="text-muted">{{ question.unit_name }}</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-muted">未設定</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="question-text" title="{{ question.question }}">
                                {{ question.question }}
                            </div>
                        </td>
                        <td>
                            <div class="answer-text" title="{{ question.correct_answer }}">
                                {{ question.correct_answer }}
                            </div>
                        </td>
                        <td>
                            {% if question.difficulty_level == 'basic' %}
                                <span class="badge bg-success">基本</span>
                            {% elif question.difficulty_level == 'intermediate' %}
                                <span class="badge bg-warning">中級</span>
                            {% elif question.difficulty_level == 'advanced' %}
                                <span class="badge bg-danger">上級</span>
                            {% else %}
                                <span class="badge bg-secondary">未設定</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ question.created_at.strftime('%Y/%m/%d') if question.created_at else '不明' }}
                            </small>
                        </td>
                        <td class="action-buttons">
                            <a href="{{ url_for('admin.input_studies_edit_question_page', question_id=question.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-info" onclick="showImageUpload({{ question.id }})">
                                <i class="fas fa-image"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion({{ question.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if not questions %}
        <div class="text-center py-5">
            <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">まだ問題が登録されていません</h4>
            <p class="text-muted">新しい問題を追加してください</p>
            <a href="{{ url_for('admin.input_studies_add_question') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>問題を追加
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- 編集モーダル -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">問題編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="edit-subject" class="form-label">科目</label>
                        <select class="form-select" id="edit-subject" name="subject" required>
                            <option value="地理">地理</option>
                            <option value="歴史">歴史</option>
                            <option value="公民">公民</option>
                            <option value="理科">理科</option>
                            <option value="英語">英語</option>
                            <option value="数学">数学</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-question" class="form-label">問題文</label>
                        <textarea class="form-control" id="edit-question" name="question" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit-correct-answer" class="form-label">正解</label>
                        <input type="text" class="form-control" id="edit-correct-answer" name="correct_answer" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-acceptable-answers" class="form-label">許容回答（カンマ区切り）</label>
                        <input type="text" class="form-control" id="edit-acceptable-answers" name="acceptable_answers" placeholder="例: 東京都, Tokyo">
                    </div>
                    <div class="mb-3">
                        <label for="edit-answer-suffix" class="form-label">解答欄の後補足</label>
                        <input type="text" class="form-control" id="edit-answer-suffix" name="answer_suffix" 
                               placeholder="例: 大陸（「オーストラリア大陸」の場合）、年（「1868年」の場合）"
                               oninput="updateEditPreview()">
                        <div class="form-text">解答欄に予め表示したい補足情報があれば入力してください</div>
                        <div id="edit-preview-section" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <small>
                                    <strong>プレビュー:</strong> 問題文の下に「答えの後に「<span id="edit-preview-suffix"></span>」が付きます」と表示されます
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-explanation" class="form-label">解説</label>
                        <textarea class="form-control" id="edit-explanation" name="explanation" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- CSV一括登録モーダル -->
<div class="modal fade" id="csvUploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">CSV一括登録</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>CSVファイル形式</h6>
                    <p class="mb-2">以下の列を含むCSVファイルをアップロードしてください：</p>
                    <ul class="mb-0">
                        <li><strong>科目</strong>: 地理、歴史、公民、理科、英語、数学のいずれか</li>
                        <li><strong>教材名</strong>: 教材の名前（存在しない場合は自動作成）</li>
                        <li><strong>単元名</strong>: 単元の名前（存在しない場合は自動作成）</li>
                        <li><strong>章番号</strong>: 章の番号（数値、空欄の場合は自動割り当て）</li>
                        <li><strong>問題文</strong>: 問題の内容（必須）</li>
                        <li><strong>正解</strong>: 正解の答え（必須）</li>
                        <li><strong>許容回答</strong>: 正解として扱う追加の回答（カンマ区切り、オプション）</li>
                        <li><strong>解答欄の補足</strong>: 解答欄に表示する補足情報（オプション）</li>
                        <li><strong>解説</strong>: 問題の解説（オプション）</li>
                        <li><strong>難易度</strong>: basic、intermediate、advancedのいずれか</li>
                        <li><strong>問題番号</strong>: 問題の番号（数値、空欄の場合は自動割り当て）</li>
                        <li><strong>画像パス</strong>: 画像のファイルパスまたはURL（オプション）</li>
                        <li><strong>textbook_id</strong>: 教材ID（既存教材使用時）</li>
                        <li><strong>unit_id</strong>: 単元ID（既存単元使用時）</li>
                    </ul>
                </div>
                
                <div class="mb-3">
                    <label for="csv-subject" class="form-label">デフォルト科目</label>
                    <select class="form-select" id="csv-subject">
                        <option value="">CSVファイルの科目を使用</option>
                        <option value="地理">地理</option>
                        <option value="歴史">歴史</option>
                        <option value="公民">公民</option>
                        <option value="理科">理科</option>
                        <option value="英語">英語</option>
                        <option value="数学">数学</option>
                    </select>
                    <div class="form-text">CSVファイルに科目が含まれていない場合のデフォルト科目を設定</div>
                </div>
                
                <div class="mb-3">
                    <label for="csv-textbook" class="form-label">デフォルト教材</label>
                    <select class="form-select" id="csv-textbook">
                        <option value="">CSVファイルの教材IDを使用</option>
                    </select>
                    <div class="form-text">CSVファイルに教材IDが含まれていない場合のデフォルト教材を設定</div>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>注意事項</h6>
                    <ul class="mb-0">
                        <li>1行目はヘッダー行として扱われます</li>
                        <li>同じ問題文と正解の組み合わせは重複登録されません</li>
                        <li>教材IDや単元IDが存在しない場合は無視されます</li>
                        <li>最大1000件まで一括登録できます</li>
                    </ul>
                </div>
                <div class="form-text mt-2">CSVファイルはUTF-8、Shift_JIS、CP932、EUC-JP、ISO-2022-JPエンコーディングに対応しています</div>
                
                <div class="mb-3">
                    <label for="csv-file" class="form-label">CSVファイル <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="csv-file" accept=".csv" required>
                    <div class="mt-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="downloadSampleCsv()">
                            <i class="fas fa-download me-1"></i>サンプルCSVをダウンロード
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadTemplateCsv()">
                            <i class="fas fa-download me-1"></i>構造付きテンプレートをダウンロード
                        </button>
                    </div>
                    <div class="form-text mt-1">
                        <strong>構造付きテンプレート</strong>: 現在の教材・単元情報と保存先フォルダパスが入力されたCSV
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="csv-upload-btn">
                    <i class="fas fa-upload me-1"></i>アップロード
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 画像アップロードモーダル -->
<div class="modal fade" id="imageUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">問題画像アップロード</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>画像アップロードについて</h6>
                    <p class="mb-2">問題に関連する画像をアップロードできます。画像はWasabiクラウドストレージに保存されます。</p>
                </div>
                
                <div class="mb-3">
                    <label for="image-file" class="form-label">画像ファイル</label>
                    <input type="file" id="image-file" name="image" accept="image/*" style="display: none;">
                    <div class="upload-area" id="image-upload-area">
                        <i class="fas fa-image fa-3x text-muted mb-3"></i>
                        <p class="mb-2">画像をドラッグ&ドロップまたはクリックして選択</p>
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('image-file').click()">
                            画像を選択
                        </button>
                    </div>
                    <div class="form-text">JPEG、PNG、GIF形式、5MB以下の画像ファイルを選択してください</div>
                </div>
                
                <div id="current-image-section" style="display: none;">
                    <h6>現在の画像</h6>
                    <div class="text-center mb-3">
                        <img id="current-image" src="" alt="現在の画像" class="img-fluid" style="max-height: 200px;">
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteCurrentImage()">
                        <i class="fas fa-trash me-1"></i>現在の画像を削除
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="image-upload-btn">
                    <i class="fas fa-upload me-1"></i>アップロード
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentEditId = null;

// 編集画面のプレビュー更新機能
function updateEditPreview() {
    const suffixInput = document.getElementById('edit-answer-suffix');
    const previewSection = document.getElementById('edit-preview-section');
    const previewSuffix = document.getElementById('edit-preview-suffix');
    
    if (suffixInput.value.trim()) {
        previewSuffix.textContent = suffixInput.value.trim();
        previewSection.style.display = 'block';
    } else {
        previewSection.style.display = 'none';
    }
}

function editQuestion(questionId) {
    currentEditId = questionId;
    
    // 問題データを取得
    fetch(`/input_studies/admin/edit_question/${questionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // モーダルのフォームにデータを設定
            document.getElementById('edit-subject').value = data.subject || '';
            document.getElementById('edit-question').value = data.question || '';
            document.getElementById('edit-correct-answer').value = data.correct_answer || '';
            document.getElementById('edit-acceptable-answers').value = data.acceptable_answers || '';
            document.getElementById('edit-answer-suffix').value = data.answer_suffix || '';
            document.getElementById('edit-explanation').value = data.explanation || '';
            
            // プレビューを更新
            updateEditPreview();
            
            // モーダルを表示
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        })
        .catch(error => {
            console.error('問題データ取得エラー:', error);
            alert('問題データの取得に失敗しました');
        });
}

function saveEdit() {
    if (!currentEditId) {
        alert('編集する問題が選択されていません');
        return;
    }
    
    // フォームデータを取得
    const formData = {
        subject: document.getElementById('edit-subject').value,
        question: document.getElementById('edit-question').value.trim(),
        correct_answer: document.getElementById('edit-correct-answer').value.trim(),
        acceptable_answers: document.getElementById('edit-acceptable-answers').value.trim(),
        answer_suffix: document.getElementById('edit-answer-suffix').value.trim(),
        explanation: document.getElementById('edit-explanation').value.trim()
    };
    
    // バリデーション
    if (!formData.subject) {
        alert('科目を選択してください');
        return;
    }
    if (!formData.question) {
        alert('問題文を入力してください');
        return;
    }
    if (!formData.correct_answer) {
        alert('正解を入力してください');
        return;
    }
    
    // 保存ボタンを無効化
    const saveButton = document.querySelector('#editModal .btn-primary');
    const originalText = saveButton.textContent;
    saveButton.disabled = true;
    saveButton.textContent = '保存中...';
    
    // APIに送信
    fetch(`/input_studies/admin/edit_question/${currentEditId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 成功時はモーダルを閉じてページを再読み込み
            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();
            location.reload();
        } else {
            // エラーメッセージを表示
            alert(data.error || '保存に失敗しました');
        }
    })
    .catch(error => {
        console.error('保存エラー:', error);
        alert('保存に失敗しました');
    })
    .finally(() => {
        // ボタンを元に戻す
        saveButton.disabled = false;
        saveButton.textContent = originalText;
    });
}

function deleteQuestion(questionId) {
    if (confirm('この問題を削除しますか？\nこの操作は取り消せません。')) {
        // 削除APIを呼び出し
        fetch(`/input_studies/admin/delete_question/${questionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 成功時はページを再読み込み
                location.reload();
            } else {
                // エラーメッセージを表示
                alert(data.error || '削除に失敗しました');
            }
        })
        .catch(error => {
            console.error('削除エラー:', error);
            alert('削除に失敗しました');
        });
    }
}

// CSV一括登録モーダル
function showCsvUpload() {
    console.log('showCsvUpload関数が呼び出されました');
    
    // 教材一覧を取得してセレクトボックスに設定
    loadTextbooksForCsv();
    
    // モーダルを表示
    const modalElement = document.getElementById('csvUploadModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('CSVモーダルを表示しました');
    } else {
        console.error('CSVモーダル要素が見つかりません');
    }
}

// 教材一覧を取得してセレクトボックスに設定
function loadTextbooksForCsv() {
    const textbookSelect = document.getElementById('csv-textbook');
    
    fetch('/social_studies/api/textbooks')
        .then(response => response.json())
        .then(data => {
            textbookSelect.innerHTML = '<option value="">CSVファイルの教材IDを使用</option>';
            data.forEach(textbook => {
                const option = document.createElement('option');
                option.value = textbook.id;
                option.textContent = `${textbook.name} (${textbook.subject})`;
                textbookSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('教材取得エラー:', error);
        });
}

// CSVファイルアップロード処理
function uploadCsv() {
    console.log('uploadCsv関数が呼び出されました');
    
    const fileInput = document.getElementById('csv-file');
    const defaultSubject = document.getElementById('csv-subject').value;
    const defaultTextbook = document.getElementById('csv-textbook').value;
    
    // ファイルチェック
    if (!fileInput.files[0]) {
        alert('CSVファイルを選択してください');
        return;
    }
    
    const file = fileInput.files[0];
    if (!file.name.endsWith('.csv')) {
        alert('CSVファイルを選択してください');
        return;
    }
    
    // アップロードボタンを無効化
    const uploadButton = document.getElementById('csv-upload-btn');
    const originalText = uploadButton.innerHTML;
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>アップロード中...';
    
    // FormDataを作成
    const formData = new FormData();
    formData.append('file', file);
    if (defaultSubject) {
        formData.append('default_subject', defaultSubject);
    }
    if (defaultTextbook) {
        formData.append('default_textbook_id', defaultTextbook);
    }
    

    
    // APIに送信
    fetch('/input_studies/admin/upload_questions_csv', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('レスポンス受信:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('レスポンスデータ:', data);
        if (data.success) {
            // 成功時はモーダルを閉じてページを再読み込み
            const modal = bootstrap.Modal.getInstance(document.getElementById('csvUploadModal'));
            if (modal) {
                modal.hide();
            }
            let message = `✅ ${data.message}\n登録件数: ${data.registered_count}件\nスキップ件数: ${data.skipped_count}件`;
            if (data.new_textbooks_created > 0) {
                message += `\n新規教材作成: ${data.new_textbooks_created}件`;
            }
            if (data.new_units_created > 0) {
                message += `\n新規単元作成: ${data.new_units_created}件`;
            }
            alert(message);
            location.reload();
        } else {
            // エラーメッセージを表示
            alert(data.error || 'アップロードに失敗しました');
        }
    })
    .catch(error => {
        console.error('アップロードエラー:', error);
        alert('アップロードに失敗しました');
    })
    .finally(() => {
        // ボタンを元に戻す
        uploadButton.disabled = false;
        uploadButton.innerHTML = originalText;
    });
}

// サンプルCSVダウンロード
function downloadSampleCsv() {
    const sampleData = [
        ['question_number', 'subject', 'question', 'correct_answer', 'difficulty_level', 'acceptable_answers', 'answer_suffix', 'explanation', 'textbook_id', 'unit_id'],
        ['# 1', '# 地理', '# 日本の首都は？', '# 東京', '# basic', '# 東京都', '# 都', '# 日本の首都は東京です', '# ', '# '],
        ['1', '地理', '日本の首都は？', '東京', 'basic', '東京都', '都', '日本の首都は東京です', '', ''],
        ['2', '歴史', '織田信長が本能寺の変で倒れた年は？', '1582年', 'intermediate', '天正10年', '年', '本能寺の変は1582年（天正10年）に発生', '', ''],
        ['3', '公民', '日本の国会は何院制？', '二院制', 'advanced', '2院制,両院制', '制', '日本の国会は衆議院と参議院の二院制', '', '']
    ];
    
    const csvContent = sampleData.map(row => row.join(',')).join('\n');
    // BOM付きUTF-8でエンコード
    const bom = '\uFEFF';
    const csvWithBom = bom + csvContent;
    const blob = new Blob([csvWithBom], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'social_studies_questions_sample.csv';
    link.click();
}

// 構造付きテンプレートCSVダウンロード
function downloadTemplateCsv() {
    // サーバーから構造付きテンプレートをダウンロード
    window.location.href = '/input_studies/admin/download_csv_template';
}

// 画像アップロード機能
let currentQuestionId = null;

function showImageUpload(questionId) {
    currentQuestionId = questionId;
    
    // 現在の画像を取得
    fetch(`/input_studies/admin/question/${questionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.question.image_url) {
                document.getElementById('current-image').src = data.question.image_url;
                document.getElementById('current-image-section').style.display = 'block';
            } else {
                document.getElementById('current-image-section').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('画像取得エラー:', error);
            document.getElementById('current-image-section').style.display = 'none';
        });
    
    // モーダルを表示
    const modal = new bootstrap.Modal(document.getElementById('imageUploadModal'));
    modal.show();
}

function uploadImage() {
    console.log('uploadImage関数が呼び出されました');
    
    // モーダル内の要素を取得
    const modal = document.getElementById('imageUploadModal');
    console.log('モーダル要素:', modal);
    
    if (!modal) {
        console.error('画像アップロードモーダルが見つかりません');
        alert('画像アップロードモーダルが見つかりません');
        return;
    }
    
    // モーダル内のすべてのinput要素を確認
    const allInputs = modal.querySelectorAll('input');
    console.log('モーダル内のすべてのinput要素:', allInputs);
    
    const fileInput = modal.querySelector('#image-file');
    console.log('ファイル入力要素:', fileInput);
    
    // ファイル入力要素が存在しない場合のエラーハンドリング
    if (!fileInput) {
        console.error('画像ファイル入力要素が見つかりません');
        console.log('モーダル内のHTML:', modal.innerHTML);
        alert('画像アップロード機能の初期化に失敗しました。ページを再読み込みしてください。');
        return;
    }
    
    if (!fileInput.files[0]) {
        alert('画像ファイルを選択してください');
        return;
    }
    
    console.log('選択されたファイル:', fileInput.files[0]);
    
    if (!currentQuestionId) {
        alert('問題IDが設定されていません');
        return;
    }
    
    console.log('問題ID:', currentQuestionId);
    
    const formData = new FormData();
    formData.append('image', fileInput.files[0]);
    
    // アップロードボタンを無効化
    const uploadButton = modal.querySelector('#image-upload-btn');
    if (!uploadButton) {
        console.error('アップロードボタンが見つかりません');
        alert('アップロードボタンが見つかりません');
        return;
    }
    
    const originalText = uploadButton.textContent;
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>アップロード中...';
    
    console.log('アップロード開始:', `/input_studies/admin/upload_image/${currentQuestionId}`);
    
    fetch(`/input_studies/admin/upload_image/${currentQuestionId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('レスポンス:', response);
        return response.json();
    })
    .then(data => {
        console.log('レスポンスデータ:', data);
        if (data.success) {
            alert('画像をアップロードしました');
            // 現在の画像を更新
            const currentImage = modal.querySelector('#current-image');
            if (currentImage) {
                currentImage.src = data.image_url;
            }
            const currentImageSection = modal.querySelector('#current-image-section');
            if (currentImageSection) {
                currentImageSection.style.display = 'block';
            }
            // ファイル入力をリセット
            fileInput.value = '';
        } else {
            alert(data.error || 'アップロードに失敗しました');
        }
    })
    .catch(error => {
        console.error('アップロードエラー:', error);
        alert('アップロードに失敗しました');
    })
    .finally(() => {
        // ボタンを元に戻す
        if (uploadButton) {
            uploadButton.disabled = false;
            uploadButton.innerHTML = originalText;
        }
    });
}

function deleteCurrentImage() {
    if (!currentQuestionId) {
        alert('問題IDが設定されていません');
        return;
    }
    
    if (confirm('現在の画像を削除しますか？')) {
        fetch(`/input_studies/admin/delete_image/${currentQuestionId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('画像を削除しました');
                document.getElementById('current-image-section').style.display = 'none';
            } else {
                alert(data.error || '削除に失敗しました');
            }
        })
        .catch(error => {
            console.error('削除エラー:', error);
            alert('削除に失敗しました');
        });
    }
}

// CSVファイル選択時の処理
document.getElementById('csv-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    console.log('CSVファイルが選択されました:', file);
    if (file) {
        console.log('ファイル詳細:', file.name, file.size, file.type);
    }
});

// 一括削除機能
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all');
    const questionCheckboxes = document.querySelectorAll('.question-checkbox');
    
    questionCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBulkDeleteButton();
}

function updateBulkDeleteButton() {
    const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    
    if (selectedCheckboxes.length > 0) {
        bulkDeleteBtn.style.display = 'inline-block';
        bulkDeleteBtn.textContent = `選択削除 (${selectedCheckboxes.length}件)`;
    } else {
        bulkDeleteBtn.style.display = 'none';
    }
}

function bulkDeleteQuestions() {
    const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('削除する問題を選択してください');
        return;
    }
    
    const questionIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
    
    if (confirm(`選択された${questionIds.length}件の問題を削除しますか？\nこの操作は取り消せません。`)) {
        fetch('/input_studies/admin/bulk_delete_questions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question_ids: questionIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.error || '一括削除に失敗しました');
            }
        })
        .catch(error => {
            console.error('一括削除エラー:', error);
            alert('一括削除に失敗しました');
        });
    }
}

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoadedイベントが発火しました');
    
    // CSVファイル選択時の処理
    const csvFileInput = document.getElementById('csv-file');
    if (csvFileInput) {
        csvFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            console.log('CSVファイルが選択されました:', file);
            if (file) {
                console.log('ファイル詳細:', file.name, file.size, file.type);
            }
        });
    }
    
    // アップロードボタンのイベントリスナー（複数の方法で設定）
    function setupUploadButton() {
        const uploadBtn = document.getElementById('csv-upload-btn');
        if (uploadBtn) {
            console.log('アップロードボタンにイベントリスナーを設定');
            
            // 既存のイベントリスナーを削除
            uploadBtn.replaceWith(uploadBtn.cloneNode(true));
            const newUploadBtn = document.getElementById('csv-upload-btn');
            
            // 新しいイベントリスナーを追加
            newUploadBtn.addEventListener('click', function(e) {
                console.log('アップロードボタンがクリックされました');
                e.preventDefault();
                e.stopPropagation();
                uploadCsv();
            });
            
            // ボタンが確実にクリック可能な状態にする
            newUploadBtn.disabled = false;
            newUploadBtn.style.pointerEvents = 'auto';
            newUploadBtn.style.cursor = 'pointer';
        }
    }
    
    // 初期設定
    setupUploadButton();
    
    // モーダル表示時の処理
    const csvModal = document.getElementById('csvUploadModal');
    if (csvModal) {
        csvModal.addEventListener('shown.bs.modal', function() {
            console.log('CSVモーダルが表示されました');
            // ファイル入力をリセット
            const fileInput = document.getElementById('csv-file');
            if (fileInput) {
                fileInput.value = '';
            }
            // モーダル表示後にボタンを再設定
            setTimeout(setupUploadButton, 100);
        });
    }
    
    // 緊急用：ボタンを強制的に有効化
    window.enableUploadButton = function() {
        const uploadBtn = document.getElementById('csv-upload-btn');
        if (uploadBtn) {
            uploadBtn.disabled = false;
            uploadBtn.style.pointerEvents = 'auto';
            uploadBtn.style.cursor = 'pointer';
            uploadBtn.onclick = function(e) {
                console.log('緊急用アップロードボタンがクリックされました');
                e.preventDefault();
                e.stopPropagation();
                uploadCsv();
            };
            console.log('緊急用ボタン有効化完了');
        }
    };
    
    // 画像ファイル選択時の処理
    const imageFileInput = document.getElementById('image-file');
    if (imageFileInput) {
        imageFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const uploadArea = document.getElementById('image-upload-area');
                uploadArea.innerHTML = `
                    <i class="fas fa-image fa-3x text-success mb-3"></i>
                    <p class="mb-2"><strong>${file.name}</strong></p>
                    <p class="text-muted">画像が選択されました</p>
                `;
            }
        });
    }
    
    // 画像アップロードボタンのイベントリスナーを設定
    const imageUploadBtn = document.getElementById('image-upload-btn');
    if (imageUploadBtn) {
        imageUploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            uploadImage();
        });
    }
    
    // 画像アップロードモーダル表示時の処理
    const imageModal = document.getElementById('imageUploadModal');
    if (imageModal) {
        imageModal.addEventListener('shown.bs.modal', function() {
            console.log('画像アップロードモーダルが表示されました');
            
            // 画像アップロードボタンのイベントリスナーを再設定
            const imageUploadBtn = document.getElementById('image-upload-btn');
            console.log('画像アップロードボタン:', imageUploadBtn);
            
            if (imageUploadBtn) {
                // 既存のイベントリスナーを削除
                imageUploadBtn.replaceWith(imageUploadBtn.cloneNode(true));
                const newImageUploadBtn = document.getElementById('image-upload-btn');
                
                // 新しいイベントリスナーを追加
                newImageUploadBtn.addEventListener('click', function(e) {
                    console.log('画像アップロードボタンがクリックされました');
                    e.preventDefault();
                    uploadImage();
                });
                
                console.log('画像アップロードボタンのイベントリスナーを設定しました');
            } else {
                console.error('画像アップロードボタンが見つかりません');
            }
        });
    }
    
    // フィルター機能の初期化
    initializeFilters();
});

// フィルター機能
function initializeFilters() {
    // URLパラメータから現在のフィルター値を設定
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('subject')) {
        document.getElementById('filter-subject').value = urlParams.get('subject');
        loadFilterTextbooks();
    }
    
    if (urlParams.get('textbook_id')) {
        document.getElementById('filter-textbook').value = urlParams.get('textbook_id');
        loadFilterUnits();
    }
    
    if (urlParams.get('unit_id')) {
        document.getElementById('filter-unit').value = urlParams.get('unit_id');
    }
    
    if (urlParams.get('difficulty')) {
        document.getElementById('filter-difficulty').value = urlParams.get('difficulty');
    }
}

function loadFilterTextbooks() {
    const subject = document.getElementById('filter-subject').value;
    const textbookSelect = document.getElementById('filter-textbook');
    const unitSelect = document.getElementById('filter-unit');
    
    // 単元セレクトをリセット
    unitSelect.innerHTML = '<option value="">全ての単元・章</option>';
    
    if (!subject) {
        textbookSelect.innerHTML = '<option value="">全ての教材</option>';
        return;
    }
    
    // 教材を取得
    fetch(`/social_studies/api/textbooks?subject=${subject}`)
        .then(response => response.json())
        .then(data => {
            textbookSelect.innerHTML = '<option value="">全ての教材</option>';
            data.forEach(textbook => {
                const option = document.createElement('option');
                option.value = textbook.id;
                option.textContent = `${textbook.name} (${textbook.subject})`;
                textbookSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('教材取得エラー:', error);
        });
}

function loadFilterUnits() {
    const textbookId = document.getElementById('filter-textbook').value;
    const unitSelect = document.getElementById('filter-unit');
    
    if (!textbookId) {
        unitSelect.innerHTML = '<option value="">全ての単元・章</option>';
        return;
    }
    
    // 単元を取得
    fetch(`/social_studies/api/units?textbook_id=${textbookId}`)
        .then(response => response.json())
        .then(data => {
            unitSelect.innerHTML = '<option value="">全ての単元・章</option>';
            data.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                const chapterText = unit.chapter_number ? `第${unit.chapter_number}章` : '';
                option.textContent = `${chapterText} ${unit.name}`;
                unitSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('単元取得エラー:', error);
        });
}

function clearFilters() {
    // フィルターフォームをリセット
    document.getElementById('filter-form').reset();
    
    // 教材と単元のセレクトをリセット
    document.getElementById('filter-textbook').innerHTML = '<option value="">全ての教材</option>';
    document.getElementById('filter-unit').innerHTML = '<option value="">全ての単元・章</option>';
    
    // 現在のページにリダイレクト（フィルターなし）
    window.location.href = window.location.pathname;
}
</script>


{% endblock %} 