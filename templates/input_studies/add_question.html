{% extends "base.html" %}

{% block title %}問題追加 - 社会科管理{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold">
                <i class="fas fa-plus me-2"></i>問題追加
            </h2>
            <p class="text-muted">
                {% if textbook_info and unit_info %}
                    {{ textbook_info.name }} - {{ unit_info.name }}
                    {% if unit_info.chapter_number %}(第{{ unit_info.chapter_number }}章){% endif %}
                {% elif textbook_info %}
                    {{ textbook_info.name }}
                {% else %}
                    新しい社会科問題を追加します
                {% endif %}
            </p>
        </div>
        <div>
            {% if textbook_info and not unit_info %}
                <a href="{{ url_for('admin.input_studies_admin_textbook_unified', textbook_id=textbook_info.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>教材管理に戻る
                </a>
            {% elif not textbook_info %}
                <a href="{{ url_for('admin.input_studies_admin_questions') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>問題一覧に戻る
                </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    {% if textbook_info and unit_info %}
                        <!-- 教材と単元が指定されている場合はhidden inputとして保持 -->
                        <input type="hidden" name="subject" value="{{ textbook_info.subject or '地理' }}">
                        <input type="hidden" name="textbook_id" value="{{ textbook_info.id }}">
                        <input type="hidden" name="unit_id" value="{{ unit_info.id }}">
                    {% else %}
                        <!-- 通常の選択形式の場合もhidden inputとして保持 -->
                        <input type="hidden" name="subject" value="地理">
                        <input type="hidden" name="textbook_id" value="">
                        <input type="hidden" name="unit_id" value="">
                    {% endif %}
                    
                    <!-- 問題タイプ選択 -->
                    <div class="mb-3">
                        <label for="question_type" class="form-label">
                            <i class="fas fa-cog me-1"></i>問題タイプ <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="question_type" name="question_type" required onchange="toggleQuestionType()">
                            <option value="">問題タイプを選択してください</option>
                            <option value="input">入力問題</option>
                            <option value="choice">選択問題</option>
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            入力問題: キーボードで答えを入力 / 選択問題: 選択肢から答えを選ぶ
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="question_number" class="form-label">
                            <i class="fas fa-hashtag me-1"></i>問題番号
                        </label>
                        <input type="number" class="form-control" id="question_number" name="question_number" 
                               placeholder="例: 1" min="1">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            空欄の場合は自動的に次の番号が割り当てられます
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="question" class="form-label">問題文 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="question" name="question" rows="3" 
                                  placeholder="例: 日本の首都はどこですか？" required></textarea>
                    </div>
                    
                    <!-- 入力問題用フィールド -->
                    <div id="input_fields" style="display: none;">
                        <div class="mb-3">
                            <label for="correct_answer" class="form-label">正解 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="correct_answer" name="correct_answer" 
                                   placeholder="例: 東京">
                        </div>
                        
                        <div class="mb-3">
                            <label for="acceptable_answers" class="form-label">許容回答</label>
                            <input type="text" class="form-control" id="acceptable_answers" name="acceptable_answers" 
                                   placeholder="例: 東京都, Tokyo（カンマ区切りで複数入力可能）">
                            <div class="form-text">正解以外でも正解として扱いたい回答があれば入力してください</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="answer_suffix" class="form-label">解答欄の後補足</label>
                            <input type="text" class="form-control" id="answer_suffix" name="answer_suffix" 
                                   placeholder="例: 大陸（「オーストラリア大陸」の場合）、年（「1868年」の場合）"
                                   oninput="updatePreview()">
                            <div class="form-text">解答欄に予め表示したい補足情報があれば入力してください</div>
                            <div id="preview-section" class="mt-2" style="display: none;">
                                <div class="alert alert-info">
                                    <small>
                                        <strong>プレビュー:</strong> 問題文の下に「答えの後に「<span id="preview-suffix"></span>」が付きます」と表示されます
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 選択問題用フィールド -->
                    <div id="choice_fields" style="display: none;">
                        <div class="mb-3">
                            <label for="correct_answer_choice" class="form-label">正解 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="correct_answer_choice" name="correct_answer_choice" 
                                   placeholder="例: 東京">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">選択肢 <span class="text-danger">*</span></label>
                            <div id="choices_container">
                                <div class="choice-item mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text">A</span>
                                        <input type="text" class="form-control" name="choice_a" placeholder="選択肢A" required>
                                        <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="choice-item mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text">B</span>
                                        <input type="text" class="form-control" name="choice_b" placeholder="選択肢B" required>
                                        <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="choice-item mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text">C</span>
                                        <input type="text" class="form-control" name="choice_c" placeholder="選択肢C" required>
                                        <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="choice-item mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text">D</span>
                                        <input type="text" class="form-control" name="choice_d" placeholder="選択肢D" required>
                                        <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addChoice()">
                                <i class="fas fa-plus me-1"></i>選択肢を追加
                            </button>
                            <div class="form-text">最低2つ、最大6つの選択肢を設定してください</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="difficulty_level" class="form-label">難易度</label>
                        <select class="form-select" id="difficulty_level" name="difficulty_level">
                            <option value="">選択なし</option>
                            <option value="basic">基本</option>
                            <option value="intermediate">中級</option>
                            <option value="advanced">上級</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="explanation" class="form-label">解説</label>
                        <textarea class="form-control" id="explanation" name="explanation" rows="2" 
                                  placeholder="問題の解説や補足情報があれば入力してください"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="image_path" class="form-label">
                            <i class="fas fa-image me-1"></i>画像パス
                        </label>
                        <input type="text" class="form-control" id="image_path" name="image_path" 
                               placeholder="例: /static/images/1.jpg または https://example.com/image.jpg">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            画像のフルパスを入力してください（ローカルファイルまたはURL）
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        {% if textbook_info and unit_info %}
                            <a href="{{ url_for('admin.input_studies_admin_unit_questions', textbook_id=textbook_info.id, unit_id=unit_info.id) }}" class="btn btn-secondary me-md-2">キャンセル</a>
                        {% elif textbook_info %}
                            <a href="{{ url_for('admin.input_studies_admin_textbook_unified', textbook_id=textbook_info.id) }}" class="btn btn-secondary me-md-2">キャンセル</a>
                        {% else %}
                            <a href="{{ url_for('admin.input_studies_admin_questions') }}" class="btn btn-secondary me-md-2">キャンセル</a>
                        {% endif %}
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 問題タイプの切り替え
function toggleQuestionType() {
    const questionType = document.getElementById('question_type').value;
    const inputFields = document.getElementById('input_fields');
    const choiceFields = document.getElementById('choice_fields');
    
    if (questionType === 'input') {
        inputFields.style.display = 'block';
        choiceFields.style.display = 'none';
        // 入力問題用のフィールドを必須にする
        document.getElementById('correct_answer').required = true;
        document.getElementById('correct_answer_choice').required = false;
    } else if (questionType === 'choice') {
        inputFields.style.display = 'none';
        choiceFields.style.display = 'block';
        // 選択問題用のフィールドを必須にする
        document.getElementById('correct_answer').required = false;
        document.getElementById('correct_answer_choice').required = true;
    } else {
        inputFields.style.display = 'none';
        choiceFields.style.display = 'none';
        document.getElementById('correct_answer').required = false;
        document.getElementById('correct_answer_choice').required = false;
    }
}

// 選択肢の追加
function addChoice() {
    const container = document.getElementById('choices_container');
    const choiceItems = container.querySelectorAll('.choice-item');
    
    if (choiceItems.length >= 6) {
        alert('選択肢は最大6つまでです');
        return;
    }
    
    const choiceLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
    const newIndex = choiceItems.length;
    const newChoice = document.createElement('div');
    newChoice.className = 'choice-item mb-2';
    newChoice.innerHTML = `
        <div class="input-group">
            <span class="input-group-text">${choiceLetters[newIndex]}</span>
            <input type="text" class="form-control" name="choice_${choiceLetters[newIndex].toLowerCase()}" placeholder="選択肢${choiceLetters[newIndex]}" required>
            <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(newChoice);
    updateChoiceButtons();
}

// 選択肢の削除
function removeChoice(button) {
    const choiceItem = button.closest('.choice-item');
    const container = document.getElementById('choices_container');
    const choiceItems = container.querySelectorAll('.choice-item');
    
    if (choiceItems.length <= 2) {
        alert('選択肢は最低2つ必要です');
        return;
    }
    
    choiceItem.remove();
    updateChoiceButtons();
    reorderChoices();
}

// 選択肢ボタンの表示/非表示を更新
function updateChoiceButtons() {
    const container = document.getElementById('choices_container');
    const choiceItems = container.querySelectorAll('.choice-item');
    const removeButtons = container.querySelectorAll('.btn-outline-danger');
    
    choiceItems.forEach((item, index) => {
        const removeButton = item.querySelector('.btn-outline-danger');
        if (choiceItems.length <= 2) {
            removeButton.style.display = 'none';
        } else {
            removeButton.style.display = 'inline-block';
        }
    });
}

// 選択肢の順序を再整理
function reorderChoices() {
    const container = document.getElementById('choices_container');
    const choiceItems = container.querySelectorAll('.choice-item');
    const choiceLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
    
    choiceItems.forEach((item, index) => {
        const letterSpan = item.querySelector('.input-group-text');
        const input = item.querySelector('input');
        letterSpan.textContent = choiceLetters[index];
        input.name = `choice_${choiceLetters[index].toLowerCase()}`;
        input.placeholder = `選択肢${choiceLetters[index]}`;
    });
}

// プレビュー更新
function updatePreview() {
    const suffix = document.getElementById('answer_suffix').value;
    const previewSection = document.getElementById('preview-section');
    const previewSuffix = document.getElementById('preview-suffix');
    
    if (suffix) {
        previewSuffix.textContent = suffix;
        previewSection.style.display = 'block';
    } else {
        previewSection.style.display = 'none';
    }
}

// ページ読み込み時の処理
document.addEventListener('DOMContentLoaded', function() {
    {% if textbook_info and unit_info %}
    // 教材と単元が固定されている場合は、単元の章番号に基づいて画像パス情報を設定
    const unitId = '{{ unit_info.id }}';
    console.log('固定表示モード: 単元ID =', unitId);
    updateUnitImagePathInfo(unitId);
    {% else %}
    // 通常の選択形式の場合
    {% if textbook_id %}
    // 教材IDが指定されている場合、教材を自動選択
    setTimeout(function() {
        const textbookSelect = document.getElementById('textbook_id');
        if (textbookSelect) {
            textbookSelect.value = '{{ textbook_id }}';
            loadUnits();
        }
    }, 500);
    {% endif %}
    
    {% if unit_id %}
    // 単元IDが指定されている場合、単元を設定
    setTimeout(function() {
        const unitSelect = document.getElementById('unit_id');
        if (unitSelect) {
            unitSelect.value = '{{ unit_id }}';
        }
    }, 1500); // 教材と単元の読み込みを待つ
    {% endif %}
    {% endif %}
});

function loadTextbooks() {
    const subject = document.getElementById('subject').value;
    const textbookSelect = document.getElementById('textbook_id');
    const unitSelect = document.getElementById('unit_id');
    
    // 単元セレクトをリセット
    unitSelect.innerHTML = '<option value="">単元・章を選択してください（オプション）</option>';
    
    // 科目が変更された場合は画像名欄もクリア
    clearImagePathInfo();
    
    if (!subject) {
        textbookSelect.innerHTML = '<option value="">教材を選択してください（オプション）</option>';
        return;
    }
    
    // 教材を取得
    fetch(`/social_studies/api/textbooks?subject=${subject}`)
        .then(response => response.json())
        .then(data => {
            textbookSelect.innerHTML = '<option value="">教材を選択してください（オプション）</option>';
            data.forEach(textbook => {
                const option = document.createElement('option');
                option.value = textbook.id;
                option.textContent = `${textbook.name} (${textbook.subject})`;
                textbookSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('教材取得エラー:', error);
        });
}

function loadUnits() {
    const textbookId = document.getElementById('textbook_id').value;
    const unitSelect = document.getElementById('unit_id');
    const statusDiv = document.getElementById('selection-status');
    const statusText = document.getElementById('status-text');
    
    if (!textbookId) {
        unitSelect.innerHTML = '<option value="">単元・章を選択してください（オプション）</option>';
        statusDiv.style.display = 'none';
        // 教材が選択されていない場合は画像名欄をクリア
        clearImagePathInfo();
        return;
    }
    
    // 選択された教材名を取得
    const selectedTextbook = document.getElementById('textbook_id').options[document.getElementById('textbook_id').selectedIndex].text;
    statusText.textContent = `教材「${selectedTextbook}」の単元・章を読み込み中...`;
    statusDiv.style.display = 'block';
    
                    // 教材の詳細情報を取得（画像フォルダパスを含む）
    fetch(`/social_studies/api/textbook/${textbookId}`)
        .then(response => response.json())
        .then(textbookData => {
            if (textbookData.error) {
                console.error('教材詳細取得エラー:', textbookData.error);
                return;
            }
            
            // 画像名欄にパス情報を表示
            updateImagePathInfo(textbookData.wasabi_folder_path);
        })
        .catch(error => {
            console.error('教材詳細取得エラー:', error);
        });
    
    // 単元を取得
    fetch(`/social_studies/api/units?textbook_id=${textbookId}`)
        .then(response => response.json())
        .then(data => {
            unitSelect.innerHTML = '<option value="">単元・章を選択してください（オプション）</option>';
            data.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                // 章番号と単元名を明確に表示
                const chapterText = unit.chapter_number ? `第${unit.chapter_number}章` : '';
                option.textContent = `${chapterText} ${unit.name}`;
                unitSelect.appendChild(option);
            });
            
            // 選択状況を更新
            if (data.length > 0) {
                statusText.textContent = `教材「${selectedTextbook}」から ${data.length}個の単元・章が見つかりました`;
            } else {
                statusText.textContent = `教材「${selectedTextbook}」には単元・章が登録されていません`;
            }
        })
        .catch(error => {
            console.error('単元取得エラー:', error);
            statusText.textContent = '単元・章の取得に失敗しました';
        });
}

// 画像名欄にパス情報を表示する関数
function updateImagePathInfo(folderPath) {
    const imageNameInput = document.getElementById('image_name');
    const imagePreviewDiv = document.getElementById('image-preview');
    const statusSpan = document.getElementById('image-status');
    
    if (folderPath) {
        // プレースホルダーを更新
        imageNameInput.placeholder = `例: 1-2 (保存先: ${folderPath})`;
        
        // パス情報を表示
        statusSpan.innerHTML = `<i class="fas fa-info-circle text-info"></i> 画像保存先: <code>${folderPath}</code>`;
        imagePreviewDiv.style.display = 'block';
        

    } else {
        clearImagePathInfo();
    }
}

// 単元IDから画像パス情報を取得して表示する関数
function updateUnitImagePathInfo(unitId) {
    const imageNameInput = document.getElementById('image_name');
    const imagePreviewDiv = document.getElementById('image-preview');
    const statusSpan = document.getElementById('image-status');
    const imagePathDisplay = document.getElementById('image_path_display');
    
    // 単元の章番号に基づいてフォルダパスを生成
    fetch(`/social_studies/api/check_image?image_name=test&unit_id=${unitId}`)
        .then(response => response.json())
        .then(data => {
            console.log('🔍 APIレスポンス:', data);
            
            // folder_pathが存在する場合（画像が見つかった場合も見つからなかった場合も）
            if (data.folder_path) {
                // 画像パス表示フィールドを更新
                if (imagePathDisplay) {
                    imagePathDisplay.value = data.folder_path;
                }
                
                // プレースホルダーを更新（問題番号のみ）
                imageNameInput.placeholder = '例: 2（問題番号のみ）';
                
                // パス情報を表示
                statusSpan.innerHTML = `<i class="fas fa-info-circle text-info"></i> 画像保存先: <code>${data.folder_path}</code>`;
                imagePreviewDiv.style.display = 'block';
                

            } else {
                // folder_pathが存在しない場合のフォールバック
                console.warn('❌ folder_pathが取得できませんでした');
                if (imagePathDisplay) {
                    imagePathDisplay.value = 'social_studies/default';
                }
            }
        })
        .catch(error => {
            console.error('単元画像パス取得エラー:', error);
            // エラーが発生した場合でも、デフォルトのフォルダパスを表示
            if (imagePathDisplay) {
                imagePathDisplay.value = 'social_studies/default';
            }
        });
}

// 単元選択時に画像パスを更新する関数
function updateImagePathOnUnitChange() {
    const unitId = document.getElementById('unit_id').value;
    const imagePathSection = document.getElementById('image_path_section');
    const imagePathDisplay = document.getElementById('image_path_display');
    
    if (unitId) {
        // 単元が選択された場合、画像パスを取得して表示
        fetch(`/social_studies/api/check_image?image_name=test&unit_id=${unitId}`)
            .then(response => response.json())
            .then(data => {
                if (data.folder_path) {
                    imagePathDisplay.value = data.folder_path;
                    imagePathSection.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('画像パス取得エラー:', error);
            });
    } else {
        // 単元が選択されていない場合、画像パスセクションを非表示
        imagePathSection.style.display = 'none';
    }
}

// 画像名欄のパス情報をクリアする関数
function clearImagePathInfo() {
    const imageNameInput = document.getElementById('image_name');
    const imagePreviewDiv = document.getElementById('image-preview');
    const statusSpan = document.getElementById('image-status');
    
    // プレースホルダーを元に戻す
    imageNameInput.placeholder = '例: 1-2';
    
    // パス情報をクリア
    statusSpan.innerHTML = '';
    imagePreviewDiv.style.display = 'none';
    
    // パス情報表示を削除
    const pathInfoDiv = document.getElementById('path-info');
    if (pathInfoDiv) {
        pathInfoDiv.remove();
    }
}

// プレビュー更新機能
function updatePreview() {
    const suffixInput = document.getElementById('answer_suffix');
    const previewSection = document.getElementById('preview-section');
    const previewSuffix = document.getElementById('preview-suffix');
    
    if (suffixInput.value.trim()) {
        previewSuffix.textContent = suffixInput.value.trim();
        previewSection.style.display = 'block';
    } else {
        previewSection.style.display = 'none';
    }
}

// 画像存在確認機能
function checkImageExists() {
    const imageName = document.getElementById('image_name').value.trim();
    const previewDiv = document.getElementById('image-preview');
    const statusSpan = document.getElementById('image-status');
    const containerDiv = document.getElementById('image-preview-container');
    
    // 単元IDを取得（固定表示の場合はhidden inputから、選択の場合はselectから）
    let unitId = null;
    
    // 固定表示モードの場合（hidden inputから取得）
    const hiddenUnitId = document.querySelector('input[name="unit_id"]');
    if (hiddenUnitId) {
        unitId = hiddenUnitId.value;
    } else {
        // 選択モードの場合（selectから取得）
        const unitIdElement = document.getElementById('unit_id');
        unitId = unitIdElement ? unitIdElement.value : null;
    }
    
    console.log('🔍 画像確認開始:', { imageName, unitId: unitId });
    
    if (!imageName) {
        previewDiv.style.display = 'none';
        return;
    }
    
    // 単元IDが取得できない場合
    if (!unitId) {
        statusSpan.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> 単元を選択してください`;
        previewDiv.style.display = 'block';
        return;
    }
    
    // ローディング表示
    statusSpan.innerHTML = `<i class="fas fa-spinner fa-spin text-info"></i> 画像を確認中...`;
    containerDiv.innerHTML = '';
    previewDiv.style.display = 'block';
    
    // 画像存在確認APIを呼び出し
    fetch(`/social_studies/api/check_image?image_name=${encodeURIComponent(imageName)}&unit_id=${unitId}`)
        .then(response => {
            console.log('🔍 APIレスポンス:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('🔍 APIデータ:', data);
            
            if (data.exists) {
                statusSpan.innerHTML = `<i class="fas fa-check-circle text-success"></i> 画像が見つかりました`;
                
                // 画像要素を作成
                const img = document.createElement('img');
                img.src = data.image_url;
                img.className = 'img-fluid';
                img.style.maxHeight = '200px';
                img.alt = '画像プレビュー';
                
                // 画像読み込みエラーハンドリング
                img.onerror = function() {
                    console.error('❌ 画像読み込みエラー:', data.image_url);
                    containerDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            画像が見つかりましたが、表示できませんでした。<br>
                            URL: ${data.image_url}
                        </div>
                    `;
                };
                
                // 画像読み込み成功
                img.onload = function() {
                    console.log('✅ 画像読み込み成功:', data.image_url);
                };
                
                containerDiv.innerHTML = '';
                containerDiv.appendChild(img);
            } else {
                statusSpan.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> ${data.message || '画像が見つかりません'}`;
                containerDiv.innerHTML = '';
            }
            previewDiv.style.display = 'block';
        })
        .catch(error => {
            console.error('❌ 画像確認エラー:', error);
            statusSpan.innerHTML = `<i class="fas fa-times-circle text-danger"></i> 画像確認に失敗しました`;
            containerDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    エラー詳細: ${error.message}
                </div>
            `;
            previewDiv.style.display = 'block';
        });
}

// 全角文字を半角に自動変換する機能（IME重複入力を防ぐため、blur時のみ実行）
function normalizeInput(input) {
    let value = input.value;
    
    // 全角数字を半角に変換
    value = value.replace(/[０-９]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
    
    // 全角英字を半角に変換
    value = value.replace(/[Ａ-Ｚａ-ｚ]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
    
    // 全角記号を半角に変換
    const fullwidthSymbols = {
        '！': '!', '＠': '@', '＃': '#', '＄': '$', '％': '%', '＾': '^', '＆': '&', '＊': '*',
        '（': '(', '）': ')', '＿': '_', '＋': '+', '－': '-', '＝': '=', '｛': '{', '｝': '}',
        '｜': '|', '：': ':', '；': ';', '＂': '"', '＇': "'", '＜': '<', '＞': '>', '？': '?',
        '、': ',', '。': '.', '・': '·', '～': '~', '　': ' '
    };
    
    for (let full in fullwidthSymbols) {
        value = value.replace(new RegExp(full, 'g'), fullwidthSymbols[full]);
    }
    
    input.value = value;
}

// すべての入力フィールドに変換機能を追加（IME重複入力を防ぐため、blur時のみ実行）
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[type="text"], textarea');
    inputs.forEach(input => {
        // IME重複入力を防ぐため、blur時（フォーカスが外れた時）のみ変換を実行
        input.addEventListener('blur', function() {
            normalizeInput(this);
        });
    });
    
    // 単元選択時の状況表示
    document.getElementById('unit_id').addEventListener('change', function() {
        const unitId = this.value;
        const statusDiv = document.getElementById('selection-status');
        const statusText = document.getElementById('status-text');
        
        if (unitId) {
            const selectedUnit = this.options[this.selectedIndex].text;
            statusText.textContent = `選択中: ${selectedUnit}`;
            statusDiv.style.display = 'block';
        } else {
            statusDiv.style.display = 'none';
        }
    });
});
</script>
{% endblock %} 