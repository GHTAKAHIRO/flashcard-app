<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>æ•™æã‚’é¸ã¶</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .source-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .source-title {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
        }
        .page-range-section {
            background: white;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .page-range-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 5px;
        }
        .page-range-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .start-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .start-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }
        .reset-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .reset-button:hover {
            background: #c82333;
        }
        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <p>ã‚ˆã†ã“ãã€{{ current_user.username }} ã•ã‚“</p>
        <a href="{{ url_for('logout') }}">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>

    <h2>ğŸ“š å­¦ç¿’ã™ã‚‹æ•™æã‚’é¸ã‚“ã§ãã ã•ã„</h2>

    {% for s in sources %}
    <div class="source-card">
        <div class="source-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“˜ {{ s.source }}ï¼ˆ{{ s.subject }} {{ s.grade }}ï¼‰</span>
            <button type="button" 
                    class="reset-button"
                    onclick="deleteHistory('{{ s.source }}')"
                    style="margin-left: 15px;">
                ğŸ—‘ å±¥æ­´å‰Šé™¤
            </button>
        </div>
        
        <form method="POST" action="{{ url_for('set_page_range_and_prepare', source=s.source) }}" class="page-range-form">
            <div class="page-range-section">
                <label for="page_range_{{ loop.index }}"><strong>ğŸ“– å­¦ç¿’ã™ã‚‹ãƒšãƒ¼ã‚¸ç¯„å›²:</strong></label>
                <input type="text" 
                       id="page_range_{{ loop.index }}" 
                       name="page_range" 
                       class="page-range-input"
                       placeholder="ä¾‹: 1-10, 15, 20-25"
                       value="{{ saved_ranges.get(s.source, '') if saved_ranges else '' }}">
                <div class="help-text">
                    ç©ºæ¬„ã®å ´åˆã¯å…¨ãƒšãƒ¼ã‚¸ãŒå¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚è¤‡æ•°ç¯„å›²ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                </div>
                <div class="error-message" id="error_{{ loop.index }}"></div>
                
                <div style="margin-top: 15px;">
                    <label for="difficulty_{{ loop.index }}"><strong>ğŸ¯ é›£æ˜“åº¦é¸æŠ:</strong></label>
                    <div style="display: flex; gap: 15px; margin-top: 8px; align-items: center;">
                        <label style="display: flex; align-items: center; font-size: 14px;">
                            <input type="checkbox" name="difficulty" value="A" style="margin-right: 5px;"
                                   {% if saved_difficulties and 'A' in saved_difficulties.get(s.source, '') %}checked{% endif %}>
                            Aï¼ˆåŸºç¤ï¼‰
                        </label>
                        <label style="display: flex; align-items: center; font-size: 14px;">
                            <input type="checkbox" name="difficulty" value="B" style="margin-right: 5px;"
                                   {% if saved_difficulties and 'B' in saved_difficulties.get(s.source, '') %}checked{% endif %}>
                            Bï¼ˆæ¨™æº–ï¼‰
                        </label>
                        <label style="display: flex; align-items: center; font-size: 14px;">
                            <input type="checkbox" name="difficulty" value="C" style="margin-right: 5px;"
                                   {% if saved_difficulties and 'C' in saved_difficulties.get(s.source, '') %}checked{% endif %}>
                            Cï¼ˆç™ºå±•ï¼‰
                        </label>
                    </div>
                    <div class="help-text">
                        ä½•ã‚‚é¸æŠã—ãªã„å ´åˆã¯å…¨é›£æ˜“åº¦ãŒå¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button type="submit" class="start-button">ğŸš€ ã“ã®è¨­å®šã§å­¦ç¿’é–‹å§‹</button>
            </div>
        </form>
        
        <!-- å±¥æ­´å‰Šé™¤ç”¨ã®ç‹¬ç«‹ã—ãŸãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="deleteForm-{{ s.source }}" method="POST" action="{{ url_for('reset_history', source=s.source) }}" style="display: none;">
        </form>
    </div>
    {% endfor %}

    <script>
        function deleteHistory(source) {
            if (confirm(source + ' ã®å­¦ç¿’å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                document.getElementById('deleteForm-' + source).submit();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('.page-range-form');
            
            forms.forEach((form, index) => {
                const input = form.querySelector('.page-range-input');
                const errorDiv = document.getElementById(`error_${index + 1}`);
                
                function validatePageRange(value) {
                    if (!value.trim()) return { valid: true }; // ç©ºæ¬„ã¯è¨±å¯
                    
                    const parts = value.split(',');
                    const rangePattern = /^\d+\s*-\s*\d+$/;
                    const numberPattern = /^\d+$/;
                    
                    for (let part of parts) {
                        part = part.trim();
                        if (!(rangePattern.test(part) || numberPattern.test(part))) {
                            return {
                                valid: false,
                                message: "ãƒšãƒ¼ã‚¸ç¯„å›²ã¯ã€Œ1-10,15,20-25ã€ã®ã‚ˆã†ã«å…¥åŠ›ã—ã¦ãã ã•ã„"
                            };
                        }
                        
                        if (rangePattern.test(part)) {
                            const [start, end] = part.split('-').map(s => parseInt(s.trim(), 10));
                            if (start > end) {
                                return {
                                    valid: false,
                                    message: `ã€Œ${part}ã€ã¯é–‹å§‹ãƒšãƒ¼ã‚¸ â‰¦ çµ‚äº†ãƒšãƒ¼ã‚¸ã«ã—ã¦ãã ã•ã„`
                                };
                            }
                        }
                    }
                    return { valid: true };
                }
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                input.addEventListener('input', function() {
                    const validation = validatePageRange(this.value);
                    if (!validation.valid) {
                        errorDiv.textContent = validation.message;
                        errorDiv.style.display = 'block';
                        input.style.borderColor = '#dc3545';
                    } else {
                        errorDiv.style.display = 'none';
                        input.style.borderColor = '#ced4da';
                    }
                });
                
                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                form.addEventListener('submit', function(e) {
                    const validation = validatePageRange(input.value);
                    if (!validation.valid) {
                        e.preventDefault();
                        errorDiv.textContent = validation.message;
                        errorDiv.style.display = 'block';
                        input.style.borderColor = '#dc3545';
                        input.focus();
                    }
                });
            });
        });
    </script>
</body>
</html>