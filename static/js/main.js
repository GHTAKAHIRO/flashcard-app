console.log("üîß „Éá„Éê„ÉÉ„Ç∞‰øÆÊ≠£Áâà main.js „ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü");

// ========== „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Âá∫Âäõ ==========
function debugCurrentState() {
    console.log("=== „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± ===");
    console.log("rawCards:", typeof rawCards !== 'undefined' ? rawCards.length : 'undefined');
    console.log("mode:", typeof mode !== 'undefined' ? mode : 'undefined');
    console.log("stage:", typeof stage !== 'undefined' ? stage : 'undefined');
    
    console.log("DOMË¶ÅÁ¥†„ÉÅ„Çß„ÉÉ„ÇØ:");
    console.log("- flashcard:", document.getElementById('flashcard'));
    console.log("- knownBtn:", document.getElementById('knownBtn'));
    console.log("- unknownBtn:", document.getElementById('unknownBtn'));
    console.log("- correct-count:", document.getElementById('correct-count'));
    console.log("- incorrect-count:", document.getElementById('incorrect-count'));
    console.log("==================");
}

// ========== ÂÆâÂÖ®„Å™ÂàùÊúüÂåñ„Ç∑„Çπ„ÉÜ„É† ==========
let cards = [];
let currentIndex = 0;
let showingAnswer = false;
let cardStatus = {};
let isPracticeMode = false;

// DOMË¶ÅÁ¥†„ÅÆÂÆâÂÖ®„Å™ÂèñÂæó
function safeGetElement(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`‚ö†Ô∏è Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${id}`);
    }
    return element;
}

// ÂÆâÂÖ®„Å™„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºËøΩÂä†
function safeAddEventListener(elementId, event, handler) {
    const element = safeGetElement(elementId);
    if (element) {
        element.addEventListener(event, handler);
        console.log(`‚úÖ „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºËøΩÂä†ÊàêÂäü: ${elementId}`);
    } else {
        console.error(`‚ùå „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºËøΩÂä†Â§±Êïó: ${elementId}`);
    }
}

document.addEventListener('DOMContentLoaded', function () {
    console.log("üöÄ DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü");
    
    // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Âá∫Âäõ
    debugCurrentState();
    
    if (typeof rawCards === "undefined") {
        console.error("‚ùå rawCards „ÅåÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ");
        return;
    }

    console.log(`üìä „Ç´„Éº„Éâ„Éá„Éº„Çø: ${rawCards.length}Êûö`);

    // Âü∫Êú¨ÁöÑ„Å™„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
    safeAddEventListener('flashcard', 'click', toggleAnswer);
    safeAddEventListener('knownBtn', 'click', markKnown);
    safeAddEventListener('unknownBtn', 'click', markUnknown);

    isPracticeMode = typeof mode !== 'undefined' && (mode === 'practice' || mode === 'chunk_practice');
    console.log("üìö Á∑¥Áøí„É¢„Éº„Éâ:", isPracticeMode);
    
    initCards(rawCards);
    setupKeyboard();
    
    console.log('‚úÖ ÂàùÊúüÂåñÂÆå‰∫Ü');
});

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function initCards(data) {
    console.log("üîÑ „Ç´„Éº„ÉâÂàùÊúüÂåñÈñãÂßã");
    
    cards = shuffle(data.slice());
    currentIndex = 0;
    showingAnswer = false;
    cardStatus = {};
    
    console.log(`üìù „Ç∑„É£„ÉÉ„Éï„É´ÂÆå‰∫Ü: ${cards.length}Êûö`);
    
    renderCard();
}

// „Ç∑„É≥„Éó„É´„Å™„Ç´„Éº„Éâ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
function renderCard() {
    console.log(`üé¥ „Ç´„Éº„Éâ„É¨„É≥„ÉÄ„É™„É≥„Ç∞: ${currentIndex + 1}/${cards.length}`);
    
    const card = cards[currentIndex];
    const cardDiv = safeGetElement('flashcard');
    
    if (!cardDiv) {
        console.error("‚ùå flashcardË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
        return;
    }
    
    if (!card) {
        console.error("‚ùå „Ç´„Éº„Éâ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
        return;
    }
    
    console.log("üìÑ Ë°®Á§∫„Ç´„Éº„Éâ:", card);
    
    // DOMÊõ¥Êñ∞
    cardDiv.innerHTML = '';

    const questionDiv = document.createElement('div');
    questionDiv.id = 'problem-container';
    
    if (card.image_problem) {
        console.log("üñºÔ∏è ÂïèÈ°åÁîªÂÉè:", card.image_problem);
        const img = document.createElement('img');
        img.src = card.image_problem;
        img.style.cssText = 'max-width: 100%; height: auto; display: block; margin: 0 auto;';
        img.alt = 'ÂïèÈ°åÁîªÂÉè';
        
        img.onload = () => console.log("‚úÖ ÂïèÈ°åÁîªÂÉèË™≠„ÅøËæº„ÅøÂÆå‰∫Ü");
        img.onerror = () => console.error("‚ùå ÂïèÈ°åÁîªÂÉèË™≠„ÅøËæº„ÅøÂ§±Êïó");
        
        questionDiv.appendChild(img);
    }
    
    if (card.problem_number && card.topic) {
        const text = document.createElement('p');
        text.textContent = `${card.problem_number}: ${card.topic}`;
        text.style.cssText = 'margin: 10px 0; font-weight: bold; text-align: center;';
        questionDiv.appendChild(text);
    }

    cardDiv.appendChild(questionDiv);

    // Ëß£Á≠îÈÉ®ÂàÜ„ÇÇÊ∫ñÂÇô
    if (card.image_answer) {
        const answerDiv = document.createElement('div');
        answerDiv.id = 'answer-container';
        answerDiv.style.display = showingAnswer ? 'block' : 'none';
        
        const answerImg = document.createElement('img');
        answerImg.src = card.image_answer;
        answerImg.style.cssText = 'max-width: 100%; height: auto; display: block; margin: 0 auto;';
        answerImg.alt = 'Ëß£Á≠îÁîªÂÉè';
        answerDiv.appendChild(answerImg);
        
        cardDiv.appendChild(answerDiv);
    }
    
    // ÈÄ≤ÊçóÊõ¥Êñ∞
    updateProgress();
    
    console.log("‚úÖ „Ç´„Éº„Éâ„É¨„É≥„ÉÄ„É™„É≥„Ç∞ÂÆå‰∫Ü");
}

function toggleAnswer() {
    console.log("üîÑ Ëß£Á≠îÂàá„ÇäÊõø„Åà");
    
    showingAnswer = !showingAnswer;
    
    const problemContainer = safeGetElement('problem-container');
    const answerContainer = safeGetElement('answer-container');
    
    if (problemContainer && answerContainer) {
        if (showingAnswer) {
            problemContainer.style.display = 'none';
            answerContainer.style.display = 'block';
            console.log("üëÅÔ∏è Ëß£Á≠îË°®Á§∫");
        } else {
            problemContainer.style.display = 'block';
            answerContainer.style.display = 'none';
            console.log("‚ùì ÂïèÈ°åË°®Á§∫");
        }
    } else {
        console.error("‚ùå Ëß£Á≠îÂàá„ÇäÊõø„ÅàË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
    }
}

function markKnown() {
    console.log("‚úÖ „Äá„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ");
    handleAnswer('known');
}

function markUnknown() {
    console.log("‚ùå √ó„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ");
    handleAnswer('unknown');
}

function handleAnswer(result) {
    console.log(`üìù ÂõûÁ≠îÂá¶ÁêÜ: ${result}`);
    
    const id = cards[currentIndex].id;
    cardStatus[id] = result;
    
    // „Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
    updateCounters(result);
    
    // „Éú„Çø„É≥„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
    const button = result === 'known' ? safeGetElement('knownBtn') : safeGetElement('unknownBtn');
    if (button) {
        button.style.transform = 'scale(0.95)';
        button.style.backgroundColor = result === 'known' ? '#45a049' : '#da190b';
        
        setTimeout(() => {
            button.style.transform = 'scale(1)';
            button.style.backgroundColor = '';
        }, 150);
    }
    
    // „Çµ„Éº„Éê„Éº„Å´ÈÄÅ‰ø°
    sendResult(id, result);
}

function updateCounters(result) {
    const correctSpan = safeGetElement('correct-count');
    const incorrectSpan = safeGetElement('incorrect-count');
    
    if (result === 'known' && correctSpan) {
        const current = parseInt(correctSpan.textContent) || 0;
        correctSpan.textContent = current + 1;
        console.log(`‚úÖ Ê≠£Ëß£„Ç´„Ç¶„É≥„Çø„Éº: ${current + 1}`);
    } else if (result === 'unknown' && incorrectSpan) {
        const current = parseInt(incorrectSpan.textContent) || 0;
        incorrectSpan.textContent = current + 1;
        console.log(`‚ùå ‰∏çÊ≠£Ëß£„Ç´„Ç¶„É≥„Çø„Éº: ${current + 1}`);
    }
}

function updateProgress() {
    const progressElement = safeGetElement('progress-info');
    if (progressElement) {
        progressElement.innerHTML = `<i class="fas fa-chart-line"></i> ${currentIndex + 1} / ${cards.length}`;
    }
}

// „Çµ„Éº„Éê„ÉºÈÄÅ‰ø°ÔºàÊó¢Â≠ò„ÅÆÈñ¢Êï∞Ôºâ
async function sendResult(cardId, result) {
    try {
        console.log('[SUBMIT] ÂõûÁ≠îÈÄÅ‰ø°ÈñãÂßã:', cardId, result, 'mode:', mode);
        
        const response = await fetch('/log_result', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                card_id: cardId,
                result: result,
                stage: stage,
                mode: mode
            })
        });

        const data = await response.json();
        console.log('[SUBMIT] „É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°:', data);

        if (data.status === 'ok') {
            // ÂÆå‰∫ÜÂà§ÂÆö
            if (data.chunk_test_completed || data.stage_test_completed) {
                console.log('[SUBMIT] „ÉÜ„Çπ„ÉàÂÆå‰∫Ü:', data);
                
                if (data.redirect_to_prepare) {
                    console.log('[SUBMIT] prepareÁîªÈù¢„Å´Êàª„Çä„Åæ„Åô');
                    showMessage(data.message);
                    setTimeout(() => {
                        const currentSource = getCurrentSource();
                        window.location.href = `/prepare/${currentSource}`;
                    }, 2000);
                    return;
                }
            }
            
            if (data.practice_completed) {
                console.log('[SUBMIT] Á∑¥ÁøíÂÆå‰∫Ü:', data);
                
                if (data.redirect_to_prepare) {
                    console.log('[SUBMIT] prepareÁîªÈù¢„Å´Êàª„Çä„Åæ„Åô');
                    showMessage(data.message);
                    setTimeout(() => {
                        const currentSource = getCurrentSource();
                        window.location.href = `/prepare/${currentSource}`;
                    }, 2000);
                    return;
                }
            }
            
            if (data.practice_continuing) {
                console.log('[SUBMIT] Á∑¥ÁøíÁ∂ôÁ∂ö:', data.remaining_count, 'ÂïèÊÆã„Çä');
                showMessage(data.message);
                
                setTimeout(() => {
                    nextCard();
                }, 1000);
                return;
            }
            
            // ÈÄöÂ∏∏„ÅÆÊ¨°„ÅÆÂïèÈ°å„Å∏
            console.log('[SUBMIT] ÈÄöÂ∏∏„ÅÆÊ¨°ÂïèÈ°å„Å∏');
            nextCard();
            
        } else {
            throw new Error(data.message || 'ÂõûÁ≠î„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }

    } catch (error) {
        console.error('[SUBMIT] „Ç®„É©„Éº:', error);
        showMessage("‚ùå „Çµ„Éº„Éê„Éº„Å∏„ÅÆË®òÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", "error");
        nextCard(); // „Ç®„É©„Éº„Åß„ÇÇÊ¨°„Å´ÈÄ≤„ÇÄ
    }
}

function nextCard() {
    console.log("‚û°Ô∏è Ê¨°„ÅÆ„Ç´„Éº„Éâ„Å∏");
    
    currentIndex++;

    if (currentIndex >= cards.length) {
        console.log('[NEXTCARD] „Ç´„Éº„ÉâÁµÇ‰∫Ü:', currentIndex, '/', cards.length);
        
        if (isPracticeMode) {
            console.log('[NEXTCARD] Á∑¥Áøí„É¢„Éº„Éâ - „Çµ„Éº„Éê„Éº„Åã„ÇâÊñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„ÇíÂæÖÊ©ü');
            showMessage("ÂïèÈ°å„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...");
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
            return;
        } else {
            console.log('[NEXTCARD] „ÉÜ„Çπ„Éà„É¢„Éº„ÉâÂÆå‰∫Ü - prepareÁîªÈù¢„Å´Êàª„Çã');
            showMessage("‚úÖ „ÉÜ„Çπ„ÉàÂÆå‰∫ÜÔºÅ");
            setTimeout(() => {
                const currentSource = getCurrentSource();
                window.location.href = `/prepare/${currentSource}`;
            }, 2000);
            return;
        }
    }

    showingAnswer = false;
    renderCard();
}

function showMessage(message, type = "info") {
    console.log('[MESSAGE]', type, ':', message);
    
    const existingMessage = document.getElementById('messageAlert');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.id = 'messageAlert';
    messageDiv.textContent = message;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#f44336' : '#4CAF50'};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-weight: bold;
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        messageDiv.style.transform = 'translateX(100%)';
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}

function getCurrentSource() {
    const pathParts = window.location.pathname.split('/');
    const source = pathParts[pathParts.length - 1];
    console.log('[SOURCE] ÁèæÂú®„ÅÆÊïôÊùê:', source);
    return source;
}

// „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
function setupKeyboard() {
    console.log("‚å®Ô∏è „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàË®≠ÂÆö");
    
    document.addEventListener('keydown', (e) => {
        switch(e.key.toLowerCase()) {
            case 'j':
            case 'arrowleft':
                e.preventDefault();
                markKnown();
                break;
            case 'f':
            case 'arrowright':
                e.preventDefault();
                markUnknown();
                break;
            case ' ':
                e.preventDefault();
                toggleAnswer();
                break;
        }
    });
}

console.log('üìà „Éá„Éê„ÉÉ„Ç∞‰øÆÊ≠£Áâà main.js Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü');